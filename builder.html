<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>De‑Ice Scenario Builder</title>
  <style>
    :root{--bg:#0b0c10;--card:#101218;--ink:#eaeaea;--muted:#96a3bf;--line:#1e2230;--accent:#1f6feb;--danger:#e5534b}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .bar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .btn{appearance:none;border:0;background:var(--accent);color:#fff;font-weight:700;border-radius:10px;padding:9px 12px;cursor:pointer}
    .ghost{background:#2b3147}
    .danger{background:var(--danger)}
    .muted{color:var(--muted)}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;margin:12px 0}
    textarea,input,select{width:100%;border:1px solid #2b3147;background:#0f1220;color:#eaeaea;border-radius:10px;padding:10px}
    textarea{min-height:120px;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:13px}
    h1{font-size:1.25rem;margin:0 0 10px}
    h2{font-size:1.05rem;margin:8px 0}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .grid{display:grid;gap:12px}
    @media(min-width:900px){.grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}}
    .status{font-size:.92rem;color:var(--muted)}
    .ok{color:#98f5b0}
    .err{color:#ffb4b4}
    .step{background:#141822;border:1px solid #243259;border-radius:12px;padding:10px}
    .lock{position:fixed;inset:0;background:linear-gradient(180deg,#0f1220,#0b0c10);display:flex;align-items:center;justify-content:center;z-index:9999}
    .lockCard{background:#101218;border:1px solid #1e2230;border-radius:16px;padding:20px;max-width:360px;width:92%}
    .hidden{display:none !important}
    .pill{display:inline-block;background:#16213a;border:1px solid #223259;color:#b7c7ff;border-radius:999px;padding:2px 8px;font-size:.75rem;font-weight:700}
    a, a:visited{color:#b7c7ff}
  </style>
</head>
<body>
  <!-- Passcode gate -->
  <div id="lock" class="lock">
    <div class="lockCard">
      <h1>Scenario Builder</h1>
      <div class="status">Enter passcode to continue.</div>
      <div class="row" style="margin-top:8px">
        <input id="code" type="password" placeholder="Passcode" autocomplete="off" autofocus>
        <button id="go" class="btn">Unlock</button>
      </div>
      <div id="msg" class="status">&nbsp;</div>
    </div>
  </div>

  <div id="app" class="wrap hidden">
    <div class="bar">
      <div class="row">
        <a href="admin.html" class="btn ghost">← Admin</a>
        <span class="pill" id="counts">—</span>
      </div>
      <div class="row">
        <button class="btn ghost" id="loadSite">Load site JSON</button>
        <button class="btn" id="downloadScenarios">⬇ Download scenarios.json</button>
      </div>
    </div>

    <div class="card">
      <h1>Scenario details</h1>
      <div class="grid2">
        <div class="grid">
          <label>Scenario ID <input id="scId" placeholder="e.g., scn2"/></label>
          <label>Label <input id="scLabel" placeholder="e.g., Type I + Type IV full body"/></label>
          <label>Description <textarea id="scDesc" placeholder="Short description"></textarea></label>
          <div class="row">
            <label class="status">Existing: <select id="existing"><option value="">— select from loaded —</option></select></label>
            <button id="loadExisting" class="btn ghost">Load</button>
          </div>
        </div>
        <div class="grid">
          <h2>Variables</h2>
          <label>TAIL <input id="varTail" placeholder="November One Two Three Alpha Bravo"></label>
          <label>FLUID_BRAND <input id="varBrand" placeholder="Cryotech Polar Guard X‑Tend"></label>
          <label>LOCAL_TIME <input id="varTime" placeholder="13:48"></label>
          <div class="row">
            <button id="applyVars" class="btn">Apply to text steps</button>
            <button id="bulkPaste" class="btn ghost">Bulk paste</button>
          </div>
          <div class="status">Tokens supported in text: <code>[TAIL]</code> <code>[FLUID_BRAND]</code> <code>[LOCAL_TIME]</code></div>
        </div>
      </div>
    </div>

    <div class="card">
      <h1>Steps</h1>
      <div id="steps"></div>
      <div class="row" style="margin-top:8px">
        <button class="btn" id="addStep">+ Add step</button>
        <button class="btn ghost" id="validate">Validate</button>
        <div id="stepStatus" class="status">Idle</div>
      </div>
    </div>

    <div class="card">
      <h1>Content JSON</h1>
      <div class="grid2">
        <div class="grid">
          <h2>Phrases (<code>phrases.json</code>)</h2>
          <div class="row">
            <button class="btn ghost" id="loadPhrases">Load /phrases.json</button>
            <label class="status">or <input id="phrasesFile" type="file" accept="application/json"></label>
          </div>
          <textarea id="phrasesBox" placeholder='[{"id":"pre","label":"...","text":"...","fluid":""}]'></textarea>
        </div>
        <div class="grid">
          <h2>Scenarios (<code>scenarios.json</code>)</h2>
          <div class="row">
            <button class="btn ghost" id="loadScenarios">Load /scenarios.json</button>
            <label class="status">or <input id="scenariosFile" type="file" accept="application/json"></label>
          </div>
          <textarea id="scenariosBox" placeholder='[{"id":"scn1","label":"...","desc":"...","steps":[{"prompt":"...","role":"Iceman","text":"..."}]}]'></textarea>
        </div>
      </div>
      <div id="status" class="status">Ready.</div>
    </div>
  </div>

  <!-- Bulk paste modal -->
  <div id="bulkModal" class="hidden" style="position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:9998">
    <div class="card" style="max-width:800px;width:95%">
      <h2>Bulk paste dialogue</h2>
      <div class="status">Paste lines beginning with <strong>Captain:</strong> or <strong>Iceman:</strong>. One line per utterance.</div>
      <textarea id="bulkText" placeholder="Captain: ...&#10;Iceman: ...&#10;Captain: ..."></textarea>
      <div class="row" style="justify-content:flex-end">
       <button class="btn ghost" id="bulkCancel" type="button">Cancel</button>
       <button class="btn" id="bulkImport" type="button">Import to steps</button>
      </div>
    </div>
  </div>

<script>
/* ===== Passcode ===== */
(function(){
  const PASSCODE='369565', KEY='adminOK';
  const lock=document.getElementById('lock'), app=document.getElementById('app');
  const code=document.getElementById('code'), go=document.getElementById('go'), msg=document.getElementById('msg');
  function unlock(){ lock.style.display='none'; app.classList.remove('hidden'); try{sessionStorage.setItem(KEY,'1');}catch{} init(); }
  function tryUnlock(){ const v=(code.value||'').trim(); if(!v){ msg.textContent='Passcode required.'; return; } msg.textContent='Checking…'; if(v===PASSCODE){ unlock(); } else { msg.textContent='Incorrect passcode.'; } }
  go.onclick=tryUnlock; code.addEventListener('keydown',e=>{ if(e.key==='Enter') tryUnlock();});
  try{ if(sessionStorage.getItem(KEY)==='1') unlock(); }catch{}
})();

/* ===== Helpers ===== */
function abs(url){ try{ return new URL(url, location.origin).href; }catch{ return url; } }
async function getJSON(path){ const res=await fetch(abs(path),{cache:'no-store'}); if(!res.ok) throw new Error('HTTP '+res.status); return res.json(); }
function setStatus(msg, cls){ const el=document.getElementById('status'); el.textContent=msg; el.className='status '+(cls||''); }
function setStepStatus(msg, cls){ const el=document.getElementById('stepStatus'); el.textContent=msg; el.className='status '+(cls||''); }
function download(name,text){ const blob=new Blob([text],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=name; a.click(); setTimeout(()=>URL.revokeObjectURL(url),1200); }
function safeParse(text,fallback){ try{ return JSON.parse(text||'[]'); }catch(_){ return fallback; } }

/* ===== App State ===== */
let steps=[];
function init(){
  const $=id=>document.getElementById(id);
  const stepsBox=$('steps'), phrasesBox=$('phrasesBox'), scenariosBox=$('scenariosBox');
  const scId=$('scId'), scLabel=$('scLabel'), scDesc=$('scDesc'), existing=$('existing');
  const counts=$('counts');

  function updateCounts(){
    try{
      const p=JSON.parse(phrasesBox.value||'[]'), s=JSON.parse(scenariosBox.value||'[]');
      counts.textContent=`${Array.isArray(p)?p.length:0} phrases • ${Array.isArray(s)?s.length:0} scenarios`;
      existing.innerHTML='<option value="">— select from loaded —</option>' + (Array.isArray(s)?s.map(x=>`<option value="${x.id}">${x.id} — ${x.label||''}</option>`).join(''):'');
    }catch{ counts.textContent='—'; }
  }

  function collectVars(){ return {TAIL:($('varTail').value||'[TAIL]'), FLUID_BRAND:($('varBrand').value||'[FLUID_BRAND]'), LOCAL_TIME:($('varTime').value||'[LOCAL_TIME]')}; }
  function applyVarsToText(t){ const v=collectVars(); return String(t||'').replaceAll('[TAIL]',v.TAIL).replaceAll('[FLUID_BRAND]',v.FLUID_BRAND).replaceAll('[LOCAL_TIME]',v.LOCAL_TIME); }

  function render(){
    stepsBox.innerHTML='';
    steps.forEach((st,idx)=>{
      const wrap=document.createElement('div');
      wrap.className='step';
      wrap.innerHTML=`
        <div class="row" style="justify-content:space-between">
          <strong>Step ${idx+1}</strong>
          <div class="row">
            <button class="btn ghost" data-up="${idx}">↑</button>
            <button class="btn ghost" data-down="${idx}">↓</button>
            <button class="btn danger" data-del="${idx}">Delete</button>
          </div>
        </div>
        <div class="row">
          <label style="flex:1 1 140px">Role
            <select data-role="${idx}">
              <option value="Captain" ${st.role==='Captain'?'selected':''}>Captain</option>
              <option value="Iceman" ${st.role==='Iceman'?'selected':''}>Iceman</option>
            </select>
          </label>
          <label style="flex:3 1 280px">Prompt
            <input data-prompt="${idx}" placeholder="e.g., Captain initiation" value="${(st.prompt||'').replace(/"/g,'&quot;')}">
          </label>
        </div>
        <div class="row">
          <label class="muted"><input type="radio" name="mode${idx}" value="text" ${st.mode!=='phrase'?'checked':''}> custom text</label>
          <label class="muted"><input type="radio" name="mode${idx}" value="phrase" ${st.mode==='phrase'?'checked':''}> phraseId</label>
        </div>
        <div data-panel="text" ${st.mode==='phrase'?'style="display:none"':''}>
          <textarea data-text="${idx}" placeholder="Exact wording (supports [TAIL], [LOCAL_TIME], [FLUID_BRAND])">${st.text||''}</textarea>
        </div>
        <div data-panel="phrase" ${st.mode==='phrase'?'':'style="display:none"'}>
          <label>Phrase
            <select data-phrase="${idx}">
              <option value="">— select a phrase —</option>
              ${safeParse(phrasesBox.value,[]).map(p=>`<option value="${p.id}" ${st.phraseId===p.id?'selected':''}>${p.id} — ${p.label||''}</option>`).join('')}
            </select>
          </label>
        </div>`;
      stepsBox.appendChild(wrap);
    });

    // Wire controls
    stepsBox.querySelectorAll('[data-del]').forEach(b=>b.onclick=()=>{ steps.splice(+b.dataset.del,1); render(); });
    stepsBox.querySelectorAll('[data-up]').forEach(b=>b.onclick=()=>{ const i=+b.dataset.up; if(i>0){ [steps[i-1],steps[i]]=[steps[i],steps[i-1]]; render(); } });
    stepsBox.querySelectorAll('[data-down]').forEach(b=>b.onclick=()=>{ const i=+b.dataset.down; if(i<steps.length-1){ [steps[i+1],steps[i]]=[steps[i],steps[i+1]]; render(); } });
    stepsBox.querySelectorAll('[data-role]').forEach(s=>s.onchange=e=>{ steps[e.target.dataset.role].role=e.target.value; });
    stepsBox.querySelectorAll('[data-prompt]').forEach(i=>i.oninput=e=>{ steps[e.target.dataset.prompt].prompt=e.target.value; });
    stepsBox.querySelectorAll('input[type=radio]').forEach(r=>r.onchange=e=>{
      const name=e.target.name, idx=+name.replace('mode',''); const mode=e.target.value;
      steps[idx].mode=mode; render();
    });
    stepsBox.querySelectorAll('[data-text]').forEach(t=>t.oninput=e=>{ steps[e.target.dataset.text].text=e.target.value; });
    stepsBox.querySelectorAll('[data-phrase]').forEach(s=>s.onchange=e=>{ steps[e.target.dataset.phrase].phraseId=e.target.value; });
  }

  // Buttons
  $('addStep').onclick=()=>{ steps.push({role:'Iceman',prompt:'',mode:'text',text:'',phraseId:''}); render(); };
  $('validate').onclick=()=>{
    const phrases=safeParse(phrasesBox.value,[]); const ids=new Set(phrases.map(p=>p.id));
    const missing=[]; steps.forEach(st=>{ if(st.mode==='phrase' && (!st.phraseId || !ids.has(st.phraseId))) missing.push(st.phraseId||'(blank)'); });
    setStepStatus(missing.length?('Missing phraseId: '+Array.from(new Set(missing)).join(', ')):'All references valid ✓', missing.length?'err':'ok');
  };
  $('applyVars').onclick=()=>{ steps.forEach(s=>{ if(s.mode!=='phrase' && s.text) s.text=applyVarsToText(s.text); }); render(); setStepStatus('Variables applied','ok'); };

// Bulk paste (modal) — robust close on Cancel/Import/ESC/backdrop
const bulkModal = document.getElementById('bulkModal');
const bulkText  = document.getElementById('bulkText');

function openBulk() {
  bulkModal.classList.remove('hidden');
  try { bulkText.focus(); } catch(_) {}
}
function closeBulk() {
  bulkModal.classList.add('hidden');
}

document.getElementById('bulkPaste').onclick = openBulk;

document.getElementById('bulkCancel').onclick = (e) => {
  e.preventDefault();
  e.stopPropagation();
  closeBulk();
};

document.getElementById('bulkImport').onclick = (e) => {
  e.preventDefault();
  e.stopPropagation();

  const raw = (bulkText.value || '').split(/\r?\n/).map(l => l.trim()).filter(Boolean);
  if (!raw.length) { setStepStatus('Nothing to import', 'err'); return; }

  const re = /^(Captain|Iceman)\s*:\s*(.+)$/i;
  const out = [];
  for (const line of raw) {
    const m = line.match(re);
    if (m) {
      out.push({
        role: m[1][0].toUpperCase() + m[1].slice(1).toLowerCase(),
        prompt: m[1] + ' line',
        mode: 'text',
        text: applyVarsToText ? applyVarsToText(m[2]) : m[2],
        phraseId: ''
      });
    }
  }
  if (!out.length) { setStepStatus('No lines matched Captain:/Iceman:', 'err'); return; }

  steps = out;
  render();
  bulkText.value = '';
  closeBulk();
  setStepStatus(`Imported ${out.length} steps ✓`, 'ok');
};

// Close on ESC and backdrop click
bulkModal.addEventListener('click', (e) => {
  if (e.target === bulkModal) closeBulk();
});
window.addEventListener('keydown', (e) => {
  if (!bulkModal.classList.contains('hidden') && e.key === 'Escape') closeBulk();
});

  $('loadPhrases').onclick=async()=>{ try{ const d=await getJSON('/phrases.json'); phrasesBox.value=JSON.stringify(d,null,2); setStatus('Loaded phrases ✓','ok'); render(); updateCounts(); }catch(e){ setStatus('Phrases load failed: '+(e.message||e),'err'); } };
  $('loadScenarios').onclick=async()=>{ try{ const d=await getJSON('/scenarios.json'); scenariosBox.value=JSON.stringify(d,null,2); setStatus('Loaded scenarios ✓','ok'); updateCounts(); }catch(e){ setStatus('Scenarios load failed: '+(e.message||e),'err'); } };
  $('scenariosFile').onchange=async(e)=>{ const f=e.target.files[0]; if(!f) return; scenariosBox.value=await f.text(); updateCounts(); setStatus('Loaded scenarios from file ✓','ok'); };
  $('phrasesFile').onchange=async(e)=>{ const f=e.target.files[0]; if(!f) return; phrasesBox.value=await f.text(); updateCounts(); setStatus('Loaded phrases from file ✓','ok'); };

  $('loadSite').onclick=async()=>{
    try{
      const [p,s]=await Promise.all([getJSON('/phrases.json').catch(()=>[]), getJSON('/scenarios.json').catch(()=>[])]);
      if(p?.length){ phrasesBox.value=JSON.stringify(p,null,2); }
      if(s?.length){ scenariosBox.value=JSON.stringify(s,null,2); }
      updateCounts(); setStatus('Loaded site JSON ✓','ok');
    }catch(e){ setStatus('Site load error: '+(e.message||e),'err'); }
  };

  $('loadExisting').onclick=()=>{
    const id=existing.value; if(!id){ setStatus('Select a scenario to load','err'); return; }
    const arr=safeParse(scenariosBox.value,[]); const sc=arr.find(x=>x.id===id);
    if(!sc){ setStatus('Scenario not found','err'); return; }
    scId.value=sc.id; scLabel.value=sc.label||''; scDesc.value=sc.desc||'';
    steps=(sc.steps||[]).map(s=>({ role:s.role||'Iceman', prompt:s.prompt||'', mode: s.phraseId?'phrase':'text', phraseId:s.phraseId||'', text:s.text||'' }));
    render(); setStatus('Loaded scenario '+id,'ok');
  };

  $('downloadScenarios').onclick=()=>{
    const sc={ id:(scId.value||'').trim(), label:(scLabel.value||'').trim(), desc:(scDesc.value||'').trim(), steps:[] };
    if(!sc.id || !sc.label){ setStatus('Scenario ID and Label are required','err'); return; }
    for(const st of steps){
      if(!st.prompt){ setStatus('Every step needs a prompt','err'); return; }
      if(st.mode==='phrase'){ if(!st.phraseId){ setStatus('A phraseId step is missing its phraseId','err'); return; } sc.steps.push({prompt:st.prompt, role:st.role, phraseId:st.phraseId}); }
      else{ const txt=(st.text||'').trim(); if(!txt){ setStatus('A text step is empty','err'); return; } sc.steps.push({prompt:st.prompt, role:st.role, text:txt}); }
    }
    // Merge into existing scenarios array if present
    const arr=safeParse(scenariosBox.value,[]);
    const i=Array.isArray(arr)?arr.findIndex(x=>x.id===sc.id):-1;
    if(i>=0) arr[i]=sc; else arr.push(sc);
    const pretty=JSON.stringify(arr,null,2);
    scenariosBox.value=pretty;
    updateCounts();
    download('scenarios.json', pretty);
    setStatus('scenarios.json downloaded ✓','ok');
  };

  // initial
  updateCounts(); render();
}
</script>
</body>
</html>
