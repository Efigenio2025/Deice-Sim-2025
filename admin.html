<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>De‑Ice Admin — Console</title>
  <style>
    :root{--bg:#0b0c10;--card:#101218;--ink:#eaeaea;--muted:#96a3bf;--line:#1e2230;--accent:#1f6feb;--danger:#e5534b}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .shell{display:grid;grid-template-columns:240px 1fr;min-height:100vh}
    .nav{background:#0d111a;border-right:1px solid var(--line);padding:16px;position:sticky;top:0;height:100vh}
    .brand{font-weight:800;margin-bottom:12px}
    .nav a{display:block;text-decoration:none;color:#cfe1ff;padding:10px 12px;border-radius:10px;margin:4px 0;border:1px solid transparent}
    .nav a[aria-current="page"]{background:#17203b;border-color:#24345f;color:#fff}
    .nav .foot{position:absolute;bottom:12px;left:16px;right:16px;font-size:.85rem;color:var(--muted)}
    .main{padding:18px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;margin-bottom:14px}
    h1{font-size:1.2rem;margin:0 0 8px}
    h2{font-size:1.05rem;margin:10px 0 8px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    textarea,input,select{width:100%;border:1px solid #2b3147;background:#0f1220;color:#eaeaea;border-radius:10px;padding:10px}
    .btn{appearance:none;border:0;background:var(--accent);color:#fff;font-weight:700;border-radius:10px;padding:9px 12px;cursor:pointer}
    .ghost{background:#2b3147}
    .danger{background:var(--danger)}
    .note{color:var(--muted);font-size:.9rem}
    .status{font-size:.92rem;color:var(--muted)}
    .grid{display:grid;gap:12px}
    .ok{color:#98f5b0}
    .err{color:#ffb4b4}
    .lock{position:fixed;inset:0;background:linear-gradient(180deg,#0f1220,#0b0c10);display:flex;align-items:center;justify-content:center;z-index:9999}
    .lockCard{background:#101218;border:1px solid #1e2230;border-radius:16px;padding:20px;max-width:360px;width:92%}
    .hidden{display:none}
    table{width:100%;border-collapse:collapse}
    th,td{padding:6px 8px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}
    .pill{display:inline-block;background:#16213a;border:1px solid #223259;color:#b7c7ff;border-radius:999px;padding:2px 8px;font-size:.75rem;font-weight:700}
  </style>
</head>
<body>
  <!-- Passcode Gate -->
  <div id="lock" class="lock">
    <div class="lockCard">
      <h1>Admin Access</h1>
      <div class="note">Enter passcode.</div>
      <div class="row">
        <input id="code" type="password" placeholder="Passcode" autocomplete="off" autofocus />
        <button id="go" class="btn" type="button">Unlock</button>
      </div>
      <div id="msg" class="status" style="min-height:1.2em">&nbsp;</div>
    </div>
  </div>

  <!-- Admin Console -->
  <div id="console" class="shell hidden">
    <nav class="nav">
      <div class="brand">De‑Ice Admin</div>
      <a href="#content" data-tab="content" aria-current="page">Content</a>
      <a href="builder.html">Builder ↗</a>
      <a href="#logs" data-tab="logs">Training Logs</a>
      <a href="#publish" data-tab="publish">Publish</a>
      <a href="diagnostics.html">Diagnostics ↗</a>
      <div class="foot">Logged in • <button id="logoutBtn" class="ghost" style="padding:4px 8px">Log out</button></div>
    </nav>

    <main class="main">
      <!-- CONTENT TAB (placeholder for your JSON editor or other content mgmt) -->
      <section id="tab-content" class="tab">
        <div class="card">
          <h1>Content</h1>
          <div class="note">Manage JSON files (scenarios.json, phrases.json) in this section. (Your existing editor or links can live here.)</div>
          <div class="row" style="margin-top:8px">
            <a class="btn ghost" href="/scenarios.json" target="_blank">Open scenarios.json</a>
            <a class="btn ghost" href="/phrases.json" target="_blank">Open phrases.json</a>
          </div>
        </div>
      </section>

      <!-- TRAINING LOGS TAB -->
      <section id="tab-logs" class="tab hidden">
        <div class="card">
          <h1>Training Logs</h1>
          <div class="note">Pulls from /api/logs-list (backed by Supabase). Filter by employee ID or scenario text.</div>
          <div class="row" style="margin:6px 0 10px">
            <input id="logFilter" placeholder="Filter (emp_id or scenario)" />
            <input id="logLimit" type="number" min="1" max="1000" value="200" style="max-width:120px" />
            <button id="fetchLogs" class="btn" type="button">Refresh</button>
            <button id="exportCsv" class="btn ghost" type="button">Export CSV</button>
          </div>
          <div id="logsInfo" class="status">—</div>
          <div id="logsTable" class="card" style="margin-top:10px;overflow:auto;max-height:60vh"></div>
        </div>
      </section>

      <!-- PUBLISH TAB (placeholder) -->
      <section id="tab-publish" class="tab hidden">
        <div class="card">
          <h1>Publish</h1>
          <div class="note">When ready, commit JSON changes to GitHub and redeploy on Vercel.</div>
          <ul class="note">
            <li>Validate JSON (no trailing commas, valid arrays).</li>
            <li>Commit to main → Vercel auto‑deploys.</li>
            <li>Verify on <span class="pill">/train.html</span>.</li>
          </ul>
        </div>
      </section>
    </main>
  </div>

  <script>
    // ===== Passcode gate =====
    (function(){
      const PASSCODE = '369565';
      const lock=document.getElementById('lock');
      const code=document.getElementById('code');
      const go=document.getElementById('go');
      const msg=document.getElementById('msg');
      const shell=document.getElementById('console');
      const KEY='adminOK';
      function unlock(){ lock.style.display='none'; shell.classList.remove('hidden'); shell.style.display='grid'; try{sessionStorage.setItem(KEY,'1');}catch(_){} }
      function tryUnlock(){ const v=(code.value||'').trim(); if(v===PASSCODE){ unlock(); } else { msg.textContent='Incorrect passcode'; } }
      go.onclick=tryUnlock; code.onkeydown=(e)=>{ if(e.key==='Enter') tryUnlock(); };
      if(sessionStorage.getItem(KEY)==='1'){ unlock(); }
      document.getElementById('logoutBtn').onclick=()=>{ try{sessionStorage.removeItem(KEY);}catch(_){} location.reload(); };
    })();

    // ===== Simple tab switcher =====
    (function(){
      const links = document.querySelectorAll('.nav a[data-tab]');
      const tabs  = { content: document.getElementById('tab-content'), logs: document.getElementById('tab-logs'), publish: document.getElementById('tab-publish') };
      function show(which){
        Object.keys(tabs).forEach(k=> tabs[k].classList.toggle('hidden', k!==which));
        links.forEach(a=> a.setAttribute('aria-current', a.dataset.tab===which ? 'page' : 'false'));
      }
      links.forEach(a=> a.addEventListener('click', (e)=>{ e.preventDefault(); show(a.dataset.tab); history.replaceState({},'', '#'+a.dataset.tab); }));
      const hash = (location.hash||'').replace('#','');
      if(['content','logs','publish'].includes(hash)) show(hash); else show('content');
    })();

    // ===== Training Logs viewer =====
    (function(){
      const ADMIN_TOKEN = Adm1n_R34d_T0ken_7788 ; // <-- replace in production

      const btn   = document.getElementById('fetchLogs');
      const inpQ  = document.getElementById('logFilter');
      const inpL  = document.getElementById('logLimit');
      const info  = document.getElementById('logsInfo');
      const table = document.getElementById('logsTable');
      const btnCsv= document.getElementById('exportCsv');

      async function fetchLogs(){
        const q = (inpQ.value||'').trim();
        const limit = Math.min(Math.max(parseInt(inpL.value||'200',10),1),1000);
        const url = `/api/logs-list?limit=${limit}${q?`&q=${encodeURIComponent(q)}`:''}`;
        const resp = await fetch(url, { headers: { 'x-admin-token': ADMIN_TOKEN } });
        if(!resp.ok){ const t = await resp.text().catch(()=> ''); throw new Error(`Fetch failed: ${resp.status} ${resp.statusText} • ${t}`); }
        return resp.json();
      }

      function renderLogs(res){
        const { rows = [], total = 0, limit = 0 } = res || {};
        info.textContent = `Rows: ${rows.length} / ${total}`;
        if(!rows.length){ table.innerHTML = '<div class="status">No logs.</div>'; return; }
        const cols = ['ts','emp_id','scenario_id','scenario_label','outcome','score','duration_sec','user_agent','ip'];
        const thead = '<thead><tr>' + cols.map(h=>`<th>${h}</th>`).join('') + '</tr></thead>';
        const tbody = '<tbody>' + rows.map(r => '<tr>' + cols.map(h => `<td>${(r[h] ?? '')}</td>`).join('') + '</tr>').join('') + '</tbody>';
        table.innerHTML = `<table>${thead}${tbody}</table>`;
      }

      function toCSV(res){
        const rows = res?.rows || []; if(!rows.length) return '';
        const cols = ['ts','emp_id','scenario_id','scenario_label','outcome','score','duration_sec','user_agent','ip'];
        const esc = (v)=>{ if(v==null) return ''; const s=String(v).replace(/"/g,'""'); return /[",\n]/.test(s)?`"${s}"`:s; };
        const lines = [cols.join(',')].concat(rows.map(r=> cols.map(c=>esc(r[c])).join(',')));
        return lines.join('\n');
      }

      btn.addEventListener('click', async ()=>{
        info.textContent='Loading…'; table.innerHTML='';
        try{ const data = await fetchLogs(); renderLogs(data); btnCsv.onclick = ()=>{ const csv = toCSV(data); if(!csv){ alert('No data'); return; } const blob = new Blob([csv],{type:'text/csv'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='training_logs.csv'; a.click(); setTimeout(()=>URL.revokeObjectURL(url), 500); }; }
        catch(e){ info.textContent = e.message || String(e); }
      });

      // Auto‑load when the Logs tab is first shown via hash
      if((location.hash||'')==='#logs') btn.click();
    })();
  </script>
</body>
</html>
