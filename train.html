<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>De‑Ice Trainer — Simulator</title>
  <style>
    :root{--bg:#0b0c10;--card:#101218;--ink:#eaeaea;--muted:#96a3bf;--line:#1e2230;--accent:#1f6feb;--danger:#e5534b;--ok:#19c37d}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;margin:12px 0}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{appearance:none;border:0;background:var(--accent);color:#fff;font-weight:700;border-radius:10px;padding:9px 12px;cursor:pointer}
    .ghost{background:#2b3147}
    .danger{background:var(--danger)}
    .status{font-size:.92rem;color:var(--muted)}
    .pill{display:inline-block;background:#16213a;border:1px solid #223259;color:#b7c7ff;border-radius:999px;padding:2px 8px;font-size:.75rem;font-weight:700}
    textarea,input,select{width:100%;border:1px solid #2b3147;background:#0f1220;color:#eaeaea;border-radius:10px;padding:10px}
    .hidden{display:none !important}
    .foot{margin-top:10px;color:#96a3bf;font-size:.85rem}
    .progress{height:12px;background:#1a2136;border:1px solid #223259;border-radius:999px;overflow:hidden}
    .bar{height:100%;width:0%;background:linear-gradient(90deg,var(--danger),#f89c2c,#f6e05e,#a4e786,var(--ok));transition:width .25s}
    .scoreline{display:flex;justify-content:space-between;align-items:center;margin-top:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="row" style="justify-content:space-between">
      <a href="index.html" class="btn ghost">← Home</a>
      <span class="pill" id="empIdBadge">ID: —</span>
    </div>

    <div class="card">
      <h1>Trainer</h1>
      <div class="row">
        <label style="flex:1 1 260px">Select scenario
          <select id="scenarioSelect"><option value="">— loading —</option></select>
        </label>
        <button id="reloadScenarios" class="btn ghost" type="button">Reload</button>
      </div>
      <div id="desc" class="status" style="margin-top:6px">Select a scenario to begin.</div>
    </div>

    <div class="card">
      <h2>Steps</h2>
      <div id="stepsBox" class="status">—</div>
      <div class="row" style="margin-top:10px">
        <button id="startBtn" class="btn" type="button">Start Simulator</button>
        <button id="speakBtn" class="btn ghost" type="button" disabled>Speak Captain</button>
        <button id="listenBtn" class="btn ghost" type="button" disabled>Listen & Grade (Iceman)</button>
        <button id="nextBtn" class="btn ghost" type="button" disabled>Next</button>
        <button id="finishBtn" class="btn danger" type="button" disabled>Mark Complete</button>
      </div>
      <div class="status" style="margin-top:6px">Auto‑advance ≥ 85% • 20s per Iceman step or scenario restarts</div>
      <div class="scoreline">
        <div class="status">Score: <span id="scorePct">0%</span></div>
        <div style="flex:1"></div>
        <div class="progress" style="width:300px"><div id="scoreBar" class="bar"></div></div>
      </div>
      <div id="status" class="status">Idle</div>
    </div>

    <div class="foot">V1 • For training purposes only • OMA Station — Microphone works only in Safari on iOS</div>
  </div>

  <!-- Employee ID Modal -->
  <div id="empIdModal" class="hidden" style="position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:9999">
    <div class="card" style="max-width:380px;width:92%">
      <h2 style="margin:0 0 8px">Enter Employee ID</h2>
      <p style="margin:0 0 10px;color:#96a3bf;font-size:.95rem">Required to log completed trainings.</p>
      <input id="empIdInput" placeholder="e.g., 123456" />
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button id="empIdCancel" class="btn ghost" type="button">Cancel</button>
        <button id="empIdSave" class="btn" type="button">Continue</button>
      </div>
      <div id="empIdMsg" style="margin-top:6px;color:#ffb4b4;font-size:.9rem;min-height:1.1em"></div>
    </div>
  </div>

  <!-- Audio player for pre‑recorded Captain lines -->
  <audio id="captainAudio" preload="metadata" playsinline></audio>

<script>
(function(){
  // ===== constants =====
  const WRITE_TOKEN = 'wR1te_Train3r_XyZ_90210'; // update if you rotate
  const EMP_ID_KEY = 'trainer.employeeId';

  // Simulator config
  const PASS_THRESHOLD = 85;          // % to pass an Iceman step
  const STEP_TIMEOUT_MS = 20000;      // 20 seconds per Iceman step
  const CAPTAIN_POST_DELAY_MS = 600;  // pause after Captain audio

  // ===== helpers =====
  const $ = id => document.getElementById(id);
  const setText = (el, t)=>{ if(el) el.textContent = t; };
  const wait = (ms)=> new Promise(res=> setTimeout(res, ms));
  const norm = s => String(s||'').toLowerCase().replace(/[^a-z0-9\s]/g,' ').replace(/\s+/g,' ').trim();
  function wordScore(expected, said){
    const e = new Set(norm(expected).split(' ').filter(Boolean));
    const s = new Set(norm(said).split(' ').filter(Boolean));
    if(e.size===0) return 0;
    let hit=0; e.forEach(w=>{ if(s.has(w)) hit++; });
    return Math.round((hit / e.size) * 100);
  }
  function setScore(pct){ pct=Math.max(0,Math.min(100, pct|0)); setText($('scorePct'), pct+'%'); $('scoreBar').style.width=pct+'%'; }

  // Role-aware token resolution
  function resolveText(txt, role){
    if(!txt) return '';
    if(role==='Iceman') return txt.replaceAll('[TAIL]','[REG]');
    return txt;
  }

  // ===== Employee ID gate =====
  function getEmployeeId(){ return sessionStorage.getItem(EMP_ID_KEY) || localStorage.getItem(EMP_ID_KEY) || ''; }
  function setEmployeeId(id){ try{ sessionStorage.setItem(EMP_ID_KEY,id); localStorage.setItem(EMP_ID_KEY,id);}catch{} }
  function ensureEmpGate(){
    const modal=$('empIdModal'), input=$('empIdInput'), save=$('empIdSave'), cancel=$('empIdCancel'), msg=$('empIdMsg'), badge=$('empIdBadge');
    function open(){ modal.classList.remove('hidden'); setTimeout(()=>input.focus(),40); }
    function close(){ modal.classList.add('hidden'); }
    const existing=getEmployeeId();
    if(!existing){ open(); } else { setText(badge,'ID: '+existing); close(); }
    save.onclick=()=>{ const v=(input.value||'').trim(); if(!/^[A-Za-z0-9_-]{3,}$/.test(v)){ setText(msg,'Enter a valid ID (min 3 chars).'); return; } setEmployeeId(v); setText(badge,'ID: '+v); setText(msg,''); close(); };
    cancel.onclick=()=>{ setText(msg,'Employee ID is required to proceed.'); };
  }

  // ===== Scenarios =====
  const SCENARIOS=[]; let current=null; let stepIndex=0; let startTs=0; let stopFlag=false;
  async function loadScenarios(){
    const sel=$('scenarioSelect'), desc=$('desc'); sel.innerHTML='<option value="">— loading —</option>';
    try{
      const ts = Date.now();
      const urls = [`/scenarios.json?v=${ts}`, `./scenarios.json?v=${ts}`];
      let data=null; for(const u of urls){ const r=await fetch(u,{cache:'no-store'}); if(r.ok){ data=await r.json(); break; } }
      if(!Array.isArray(data)) throw new Error('Invalid scenarios.json');
      SCENARIOS.splice(0,SCENARIOS.length,...data);
      sel.innerHTML = '<option value="">— select —</option>'+data.map(s=>`<option value="${s.id}">${s.label||s.id}</option>`).join('');
      setText(desc,'Select a scenario to begin.');
    }catch(e){ sel.innerHTML='<option value="">(load failed)</option>'; setText(desc,'Could not load scenarios.json'); }
  }

  function renderSteps(){
    const box=$('stepsBox');
    if(!current){ box.textContent='—'; return; }
    const steps=current.steps||[];
    box.innerHTML = steps.map((s,i)=>{
      const active = i===stepIndex;
      const txt = resolveText(s.text||s.phraseId||'', s.role);
      return `<div style="padding:8px;border:1px solid ${active?'#1f6feb':'#1e2230'};border-radius:10px;margin:6px 0;background:${active?'#0f1424':'#141822'}">
        <div style=\"display:flex;justify-content:space-between;align-items:center\"><strong>Step ${i+1} • ${s.role||''}</strong><span class='status'>${s.prompt||''}</span></div>
        <div style=\"margin-top:6px\">${txt.replace(/</g,'&lt;')}</div>
      </div>`;
    }).join('');
  }

  // ===== Pre‑recorded audio playback for Captain lines =====
  function playCaptainAudio(src) {
    const audio = $('captainAudio');
    if (!audio) return;
    try { audio.pause(); audio.currentTime = 0; audio.src = (/^https?:\/\//i.test(src)) ? src : `/audio/${src}`; const p = audio.play(); if (p && p.catch) { p.catch(err => { setText($('status'), 'Audio failed: ' + (err?.message || err)); }); } }
    catch (e) { setText($('status'), 'Audio error: ' + (e?.message || e)); }
  }
  function stopCaptainAudio(){ const a=$('captainAudio'); try{ a.pause(); }catch{} }

  // ===== Optional TTS fallback (kept but unused) =====
  function speak(text){ try{ const u=new SpeechSynthesisUtterance(text); u.lang='en-US'; speechSynthesis.cancel(); speechSynthesis.speak(u);}catch{} }

  // ===== STT (listen Iceman) — iOS Safari uses webkitSpeechRecognition =====
  function makeRecognizer(){ const R = window.SpeechRecognition || window.webkitSpeechRecognition; if(!R) return null; const rec = new R(); rec.lang='en-US'; rec.continuous=false; rec.interimResults=false; rec.maxAlternatives=1; return rec; }
  async function listenOnce(){ return new Promise((resolve,reject)=>{ const rec = makeRecognizer(); if(!rec){ reject(new Error('Speech Recognition not supported. Use Safari on iOS.')); return; } rec.onresult = (ev)=>{ const t = ev.results[0][0].transcript || ''; resolve(t); }; rec.onerror = (e)=>reject(new Error(e.error||'mic error')); try{ rec.start(); }catch(e){ reject(e); } }); }

  // ===== Cloud logging =====
  async function logTrainingCloud({ empId, scenarioId, scenarioLabel, outcome='completed', score='', durationSec='' }){
    const statusEl = $('status');
    try{
      if(!empId || empId.trim().length<3){ statusEl.textContent='Cloud log blocked: Employee ID missing.'; return false; }
      const resp = await fetch('/api/logs-write', { method:'POST', headers:{ 'Content-Type':'application/json', 'x-write-token': WRITE_TOKEN }, body: JSON.stringify({ emp_id: empId, scenario_id: scenarioId||'', scenario_label: scenarioLabel||'', outcome, score, duration_sec: durationSec||null }) });
      if(!resp.ok){ const body=await resp.text().catch(()=> ''); statusEl.textContent=`Cloud log failed • ${resp.status} ${resp.statusText} • ${body}`; return false; }
      statusEl.textContent='Logged to cloud ✓'; return true;
    }catch(e){ statusEl.textContent=`Cloud log error • ${e?.message||e}`; return false; }
  }

  // ===== Simulator helpers =====
  const expectedFor = (st) => resolveText(st.text || st.phraseId || '', st.role);

  async function playCaptainAndAwait(st) {
    const audioSrc = st.audio || st.audioUrl || null;
    if (!audioSrc) { await wait(CAPTAIN_POST_DELAY_MS); return; }
    return new Promise((resolve) => {
      const a = $('captainAudio');
      try { a.pause(); a.currentTime = 0; a.src = (/^https?:\/\//i.test(audioSrc)) ? audioSrc : `/audio/${audioSrc}`; a.onended = () => resolve(); const p = a.play(); setText($('status'), 'Playing Captain line…'); if (p && p.catch) p.catch(()=> resolve()); }
      catch { resolve(); }
    });
  }

  async function listenUntilPass(st, timeoutMs = STEP_TIMEOUT_MS) {
    const endBy = Date.now() + timeoutMs; let best = 0;
    while (Date.now() < endBy && !stopFlag) {
      setText($('status'),'Listening…');
      try { const heard = await listenOnce(); const exp = expectedFor(st); const score = wordScore(exp, heard); setScore(score); setText($('status'), `Heard: \"${heard}\"`); best = Math.max(best, score); if (score >= PASS_THRESHOLD) return { passed: true, score }; }
      catch (e) { setText($('status'), 'Mic error: '+(e.message||e)); await wait(600); }
      await wait(400);
    }
    return { passed: false, score: best };
  }

  async function runSimulator() {
    if (!current) return;
    const steps = current?.steps || [];
    if (!steps.length) return;

    stopFlag = false;
    startTs = Date.now();
    stepIndex = 0; setScore(0); renderSteps();

    // Lock manual controls
    $('nextBtn').disabled = true; $('speakBtn').disabled = true; $('listenBtn').disabled = true; $('finishBtn').disabled = false;
    setText($('status'), 'Simulator running…');

    while (!stopFlag) {
      for (let i = 0; i < steps.length && !stopFlag; i++) {
        stepIndex = i; renderSteps();
        const st = steps[i];
        if (st.role === 'Captain') {
          await playCaptainAndAwait(st);
          await wait(CAPTAIN_POST_DELAY_MS);
        } else {
          const { passed, score } = await listenUntilPass(st, STEP_TIMEOUT_MS);
          if (!passed) {
            setText($('status'), `Time up (best ${score}%). Restarting from Step 1…`);
            stopCaptainAudio();
            await wait(1000);
            i = -1; // loop will ++ to 0
            stepIndex = 0; setScore(0); renderSteps();
            continue;
          }
        }
      }

      // Completed one full run
      const duration = Math.round((Date.now() - startTs)/1000) || '';
      const score = parseInt(($('scorePct').textContent||'0'),10) || 0;
      await logTrainingCloud({ empId: getEmployeeId(), scenarioId: current.id||'', scenarioLabel: current.label||'', outcome:'completed', score:String(score), durationSec:duration });

      setText($('status'), 'Scenario complete. Restarting in 2s…');
      await wait(2000);
      stepIndex = 0; renderSteps();
    }
  }

  // ===== Wire UI =====
  document.addEventListener('DOMContentLoaded', ()=>{
    ensureEmpGate();
    loadScenarios();

    $('reloadScenarios').onclick=loadScenarios;
    $('scenarioSelect').onchange = (e)=>{
      const id=e.target.value; current=SCENARIOS.find(s=>s.id===id)||null; setText($('desc'), current?(current.desc||''):'Select a scenario to begin.'); stepIndex=0; renderSteps();
      $('startBtn').disabled = !current; $('nextBtn').disabled=true; $('finishBtn').disabled=true; $('speakBtn').disabled=true; $('listenBtn').disabled=true; setText($('status'),'Idle'); setScore(0); stopCaptainAudio();
    };

    $('startBtn').onclick = ()=>{ if(!current) return; runSimulator().catch(()=>{}); };

    $('speakBtn').onclick=()=>{ const st = current?.steps?.[stepIndex]; if(!st) return; const audioSrc = st.audio || st.audioUrl || null; if(audioSrc){ playCaptainAudio(audioSrc); setText($('status'),'Playing Captain line…'); } else { setText($('status'),'No audio file defined for this Captain line.'); } };

    $('listenBtn').onclick=async()=>{ const st = current?.steps?.[stepIndex]; if(!st) return; const expected = resolveText(st.text||'', 'Iceman'); setText($('status'),'Listening…'); try{ const heard = await listenOnce(); const score = wordScore(expected, heard); setScore(score); setText($('status'), `Heard: \"${heard}\"`); } catch(e){ setText($('status'), 'Mic error: '+(e.message||e)); } };

    $('nextBtn').onclick=()=>{ if(!current) return; const total=(current.steps||[]).length; if(total===0) return; stopCaptainAudio(); stepIndex = Math.min(stepIndex+1, total-1); renderSteps(); setText($('status'),'Step '+(stepIndex+1)+' of '+total); };

    $('finishBtn').onclick=async()=>{ stopFlag = true; stopCaptainAudio(); if(!current) return; const duration = Math.round((Date.now()-startTs)/1000)||''; const score = parseInt(($('scorePct').textContent||'0'),10)||0; await logTrainingCloud({ empId:getEmployeeId(), scenarioId: current.id||'', scenarioLabel: current.label||'', outcome:'completed', score:String(score), durationSec:duration }); $('nextBtn').disabled=true; $('finishBtn').disabled=true; $('speakBtn').disabled=true; $('listenBtn').disabled=true; setText($('status'),'Stopped.'); };
  });
})();
</script>
</body>
</html>
