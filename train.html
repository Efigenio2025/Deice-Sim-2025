<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>De‑Ice Trainer</title>
  <style>
    :root{--bg:#0b0c10;--card:#101218;--ink:#eaeaea;--muted:#96a3bf;--line:#1e2230;--accent:#1f6feb;--danger:#e5534b}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;margin:12px 0}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{appearance:none;border:0;background:var(--accent);color:#fff;font-weight:700;border-radius:10px;padding:9px 12px;cursor:pointer}
    .ghost{background:#2b3147}
    .danger{background:var(--danger)}
    .status{font-size:.92rem;color:var(--muted)}
    .pill{display:inline-block;background:#16213a;border:1px solid #223259;color:#b7c7ff;border-radius:999px;padding:2px 8px;font-size:.75rem;font-weight:700}
    textarea,input,select{width:100%;border:1px solid #2b3147;background:#0f1220;color:#eaeaea;border-radius:10px;padding:10px}
    textarea{min-height:120px;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:13px}
    .hidden{display:none !important}
    .dim{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:9999}
    .modal{background:#101218;border:1px solid #1e2230;border-radius:14px;padding:16px;max-width:380px;width:92%}
    a, a:visited{color:#cfe1ff}
    .foot{margin-top:10px;color:#96a3bf;font-size:.85rem}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="row" style="justify-content:space-between">
      <a href="index.html" class="btn ghost">← Home</a>
      <span class="pill" id="empIdBadge">ID: —</span>
    </div>

    <div class="card">
      <h1>Trainer</h1>
      <div class="row">
        <label style="flex:1 1 260px">Select scenario
          <select id="scenarioSelect"><option value="">— loading —</option></select>
        </label>
        <button id="reloadScenarios" class="btn ghost" type="button">Reload</button>
      </div>
      <div id="desc" class="status" style="margin-top:6px">Select a scenario to begin.</div>
    </div>

    <div class="card">
      <h2>Steps</h2>
      <div id="stepsBox" class="status">—</div>
      <div class="row" style="margin-top:10px">
        <button id="startBtn" class="btn" type="button">Start</button>
        <button id="nextBtn" class="btn ghost" type="button" disabled>Next</button>
        <button id="finishBtn" class="btn danger" type="button" disabled>Mark Complete</button>
      </div>
      <div id="status" class="status">Idle</div>
    </div>

    <div class="foot">V1 • For training purposes only • OMA Station — Microphone works only in Safari on iOS</div>
  </div>

  <!-- Employee ID Modal -->
  <div id="empIdModal" class="dim">
    <div class="modal">
      <h2 style="margin:0 0 8px">Enter Employee ID</h2>
      <p style="margin:0 0 10px;color:#96a3bf;font-size:.95rem">Required to log completed trainings.</p>
      <input id="empIdInput" placeholder="e.g., 123456" />
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button id="empIdCancel" class="btn ghost" type="button">Cancel</button>
        <button id="empIdSave" class="btn" type="button">Continue</button>
      </div>
      <div id="empIdMsg" style="margin-top:6px;color:#ffb4b4;font-size:.9rem;min-height:1.1em"></div>
    </div>
  </div>

<script>
// ===== Config =====
// If you must send a token from client, put it here for local testing only and REMOVE before public deploy.
const WRITE_TOKEN = wR1te_Train3r_XyZ_90210;

// ===== Employee ID =====
const EMP_ID_KEY = 'trainer.employeeId';
function getEmployeeId(){ return sessionStorage.getItem(EMP_ID_KEY) || localStorage.getItem(EMP_ID_KEY) || ''; }
function setEmployeeId(id){ try{ sessionStorage.setItem(EMP_ID_KEY,id); localStorage.setItem(EMP_ID_KEY,id);}catch(_){} }

(function employeeGate(){
  const modal = document.getElementById('empIdModal');
  const input = document.getElementById('empIdInput');
  const save  = document.getElementById('empIdSave');
  const cancel= document.getElementById('empIdCancel');
  const msg   = document.getElementById('empIdMsg');
  const badge = document.getElementById('empIdBadge');

  function open(){ modal.classList.remove('hidden'); setTimeout(()=>input.focus(), 40); }
  function close(){ modal.classList.add('hidden'); }

  const existing = getEmployeeId();
  if(!existing){ open(); } else { badge.textContent = 'ID: ' + existing; modal.classList.add('hidden'); }

  save.onclick = ()=>{
    const v=(input.value||'').trim();
    if(!/^[A-Za-z0-9_-]{3,}$/.test(v)){ msg.textContent='Enter a valid ID (min 3 chars).'; return; }
    setEmployeeId(v); badge.textContent='ID: '+v; msg.textContent=''; close();
  };
  cancel.onclick = ()=>{ msg.textContent='Employee ID is required to proceed.'; };
})();

// ===== Load scenarios.json =====
const scenarios = [];
async function loadScenarios(){
  const sel = document.getElementById('scenarioSelect');
  const desc= document.getElementById('desc');
  sel.innerHTML = '<option value="">— loading —</option>';
  try{
    const res = await fetch('/scenarios.json', { cache:'no-store' });
    if(!res.ok) throw new Error('HTTP '+res.status);
    const data = await res.json();
    scenarios.splice(0,scenarios.length, ...data);
    sel.innerHTML = '<option value="">— select —</option>' + data.map(s=>`<option value="${s.id}">${s.label||s.id}</option>`).join('');
    desc.textContent='Select a scenario to begin.';
  }catch(e){ sel.innerHTML='<option value="">(failed to load)</option>'; desc.textContent='Could not load scenarios.json'; }
}

// ===== UI state =====
let current = null; let startTs = 0; let stepIndex = 0;
function renderSteps(){
  const box = document.getElementById('stepsBox');
  if(!current){ box.textContent='—'; return; }
  const steps = current.steps || [];
  const items = steps.map((s,i)=>{
    const isActive = i===stepIndex;
    return `<div style="padding:8px;border:1px solid ${isActive?'#1f6feb':'#1e2230'};border-radius:10px;margin:6px 0;background:${isActive?'#0f1424':'#141822'}">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>Step ${i+1} • ${s.role||''}</strong>
        <span class="status">${s.prompt||''}</span>
      </div>
      <div style="margin-top:6px">${(s.text||s.phraseId||'').toString().replace(/</g,'&lt;')}</div>
    </div>`;
  }).join('');
  box.innerHTML = items || '<div class="status">No steps</div>';
}

// ===== Controls =====
const startBtn = document.getElementById('startBtn');
const nextBtn  = document.getElementById('nextBtn');
const finishBtn= document.getElementById('finishBtn');
const statusEl = document.getElementById('status');

document.getElementById('reloadScenarios').onclick = loadScenarios;
document.getElementById('scenarioSelect').onchange = (e)=>{
  const id = e.target.value; current = scenarios.find(s=>s.id===id) || null;
  const d = document.getElementById('desc');
  if(current){ d.textContent = current.desc || ''; }
  stepIndex = 0; renderSteps();
  startBtn.disabled = !current; nextBtn.disabled = true; finishBtn.disabled = true; statusEl.textContent='Idle';
};

startBtn.onclick = ()=>{
  if(!current){ statusEl.textContent='Select a scenario first'; return; }
  startTs = Date.now(); stepIndex = 0; renderSteps();
  nextBtn.disabled = false; finishBtn.disabled = false; statusEl.textContent='In progress…';
};

nextBtn.onclick = ()=>{
  if(!current) return; const total=(current.steps||[]).length; if(total===0) return;
  stepIndex = Math.min(stepIndex+1, total-1); renderSteps();
};

finishBtn.onclick = async ()=>{
  if(!current) return;
  const duration = Math.round((Date.now()-startTs)/1000) || '';
  const ok = await logTrainingCloud({
    empId: getEmployeeId(),
    scenarioId: current.id || '',
    scenarioLabel: current.label || '',
    outcome: 'completed',
    score: '',
    durationSec: duration
  });
  statusEl.textContent = ok ? 'Logged to cloud ✓' : 'Completed (cloud log failed, see console)';
  nextBtn.disabled = true; finishBtn.disabled = true;
};

// ===== Cloud logging =====
async function logTrainingCloud({ empId, scenarioId, scenarioLabel, outcome='completed', score='', durationSec='' }){
  try{
    const resp = await fetch('/api/logs-write', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        // If your server requires WRITE_TOKEN header, replace below before public deploy
        ...(WRITE_TOKEN && WRITE_TOKEN!== wR1te_Train3r_XyZ_90210 ? { 'x-write-token': WRITE_TOKEN } : {})
      },
      body: JSON.stringify({
        emp_id: empId,
        scenario_id: scenarioId,
        scenario_label: scenarioLabel,
        outcome,
        score,
        duration_sec: durationSec
      })
    });
    if(!resp.ok){ console.warn('cloud log failed', resp.status); return false; }
    const data = await resp.json(); console.log('cloud log ok', data); return true;
  }catch(e){ console.error('cloud log error', e); return false; }
}

// ===== Init =====
loadScenarios();
renderSteps();
</script>
</body>
</html>
