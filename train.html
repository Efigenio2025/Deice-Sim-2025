<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>De‑Ice Trainer</title>
  <style>
    :root{--bg:#0b0c10;--card:#101218;--ink:#eaeaea;--muted:#96a3bf;--line:#1e2230;--accent:#1f6feb;--danger:#e5534b}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;margin:12px 0}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{appearance:none;border:0;background:var(--accent);color:#fff;font-weight:700;border-radius:10px;padding:9px 12px;cursor:pointer}
    .ghost{background:#2b3147}
    .danger{background:var(--danger)}
    .status{font-size:.92rem;color:var(--muted)}
    .pill{display:inline-block;background:#16213a;border:1px solid #223259;color:#b7c7ff;border-radius:999px;padding:2px 8px;font-size:.75rem;font-weight:700}
    textarea,input,select{width:100%;border:1px solid #2b3147;background:#0f1220;color:#eaeaea;border-radius:10px;padding:10px}
    textarea{min-height:120px;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:13px}
    .hidden{display:none !important}
    .dim{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:9999}
    .modal{background:#101218;border:1px solid #1e2230;border-radius:14px;padding:16px;max-width:380px;width:92%}
    a, a:visited{color:#cfe1ff}
    .foot{margin-top:10px;color:#96a3bf;font-size:.85rem}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="row" style="justify-content:space-between">
      <a href="index.html" class="btn ghost">← Home</a>
      <span class="pill" id="empIdBadge">ID: —</span>
    </div>

    <div class="card">
      <h1>Trainer</h1>
      <div class="row">
        <label style="flex:1 1 260px">Select scenario
          <select id="scenarioSelect"><option value="">— loading —</option></select>
        </label>
        <button id="reloadScenarios" class="btn ghost" type="button">Reload</button>
      </div>
      <div id="desc" class="status" style="margin-top:6px">Select a scenario to begin.</div>
      <div class="status" style="margin-top:6px">If loading fails, open <a href="/scenarios.json" target="_blank" rel="noopener">/scenarios.json</a> or <a href="./scenarios.json" target="_blank" rel="noopener">./scenarios.json</a>.</div>
    </div>

    <div class="card">
      <h2>Steps</h2>
      <div id="stepsBox" class="status">—</div>
      <div class="row" style="margin-top:10px">
        <button id="startBtn" class="btn" type="button">Start</button>
        <button id="nextBtn" class="btn ghost" type="button" disabled>Next</button>
        <button id="finishBtn" class="btn danger" type="button" disabled>Mark Complete</button>
      </div>
      <div id="status" class="status">Idle</div>
    </div>

    <div class="foot">V1 • For training purposes only • OMA Station — Microphone works only in Safari on iOS</div>
  </div>

  <!-- On‑screen error panel -->
  <div id="errorBox" class="status" style="color:#ffb4b4;margin:12px 16px 24px"></div>

  <!-- Employee ID Modal -->
  <div id="empIdModal" class="dim">
    <div class="modal">
      <h2 style="margin:0 0 8px">Enter Employee ID</h2>
      <p style="margin:0 0 10px;color:#96a3bf;font-size:.95rem">Required to log completed trainings.</p>
      <input id="empIdInput" placeholder="e.g., 123456" />
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button id="empIdCancel" class="btn ghost" type="button">Cancel</button>
        <button id="empIdSave" class="btn" type="button">Continue</button>
      </div>
      <div id="empIdMsg" style="margin-top:6px;color:#ffb4b4;font-size:.9rem;min-height:1.1em"></div>
    </div>
  </div>

<script>
(function(){
  // ===== util =====
  const $ = (id)=>document.getElementById(id);
  const setText = (el, txt)=>{ if(el) el.textContent = txt; };
  const showErr = (msg, e)=>{ console.error(msg, e||''); setText($('errorBox'), msg); };

  // ===== constants =====
  // Option A: we use a client token. You provided this value.
  const WRITE_TOKEN = 'wR1te_Train3r_XyZ_90210';

  // ===== state =====
  const scenarios = [];
  let current = null, startTs = 0, stepIndex = 0;

  // ===== employee id gate =====
  const EMP_ID_KEY = 'trainer.employeeId';
  const getEmployeeId = ()=> sessionStorage.getItem(EMP_ID_KEY) || localStorage.getItem(EMP_ID_KEY) || '';
  const setEmployeeId = (id)=>{ try{ sessionStorage.setItem(EMP_ID_KEY,id); localStorage.setItem(EMP_ID_KEY,id);}catch{} };

  function initEmployeeGate(){
    const modal = $('empIdModal'), input = $('empIdInput'), save=$('empIdSave'), cancel=$('empIdCancel'), msg=$('empIdMsg'), badge=$('empIdBadge');
    if(!modal || !input || !save || !cancel || !badge){ showErr('Employee ID modal elements missing.'); return; }
    function open(){ modal.classList.remove('hidden'); setTimeout(()=>input.focus(), 40); }
    function close(){ modal.classList.add('hidden'); }

    const existing = getEmployeeId();
    if(!existing){ open(); } else { setText(badge, 'ID: '+existing); close(); }

    save.onclick = ()=>{
      const v=(input.value||'').trim();
      if(!/^[A-Za-z0-9_-]{3,}$/.test(v)){ setText(msg, 'Enter a valid ID (min 3 chars).'); return; }
      setEmployeeId(v); setText(badge, 'ID: '+v); setText(msg,''); close();
    };
    // keep Cancel blocked to enforce ID
    cancel.onclick = ()=>{ setText(msg,'Employee ID is required to proceed.'); };
  }

  // ===== scenarios loader (robust) =====
  async function loadScenarios(){
    const sel  = $('scenarioSelect');
    const desc = $('desc');
    const statusEl = $('status');
    if(!sel || !desc){ showErr('Scenario selector elements missing.'); return; }

    sel.innerHTML = '<option value="">— loading —</option>';
    setText(desc,'Loading scenarios…');

    const ts = Date.now();
    const candidates = [`/scenarios.json?v=${ts}`, `./scenarios.json?v=${ts}`, `/data/scenarios.json?v=${ts}`];

    let data=null, used='', lastErr=null;
    for(const url of candidates){
      try{
        const res = await fetch(url, { cache:'no-store' });
        if(!res.ok) throw new Error(`HTTP ${res.status} for ${url}`);
        const text = await res.text();
        try{ data = JSON.parse(text); } catch(e){ throw new Error(`Invalid JSON at ${url}: ${e.message}`); }
        if(!Array.isArray(data)) throw new Error(`Expected an array at ${url}`);
        used = url; break;
      }catch(e){ lastErr=e; }
    }

    if(!data){
      const msg = `Failed to load scenarios. ${lastErr ? lastErr.message : ''}`;
      sel.innerHTML = '<option value="">(load failed)</option>';
      setText(desc, msg); setText(statusEl, msg); showErr(msg, lastErr);
      return;
    }

    scenarios.splice(0, scenarios.length, ...data);
    sel.innerHTML = '<option value="">— select —</option>' + data.map(s=>`<option value="${s.id}">${s.label||s.id}</option>`).join('');
    desc.innerHTML = `Loaded ${data.length} scenario(s) from <code>${used.replace(/\\?v=.*/, '')}</code>`;
    setText(statusEl, 'Scenarios loaded ✓');
  }

  // ===== render =====
  function renderSteps(){
    const box = $('stepsBox');
    if(!box){ showErr('Steps box missing.'); return; }
    if(!current){ box.textContent='—'; return; }
    const items = (current.steps||[]).map((s,i)=>{
      const active = i===stepIndex;
      return `<div style="padding:8px;border:1px solid ${active?'#1f6feb':'#1e2230'};border-radius:10px;margin:6px 0;background:${active?'#0f1424':'#141822'}">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>Step ${i+1} • ${s.role||''}</strong>
          <span class="status">${s.prompt||''}</span>
        </div>
        <div style="margin-top:6px">${(s.text||s.phraseId||'').toString().replace(/</g,'&lt;')}</div>
      </div>`;
    }).join('');
    box.innerHTML = items || '<div class="status">No steps</div>';
  }

  // ===== cloud logging =====
  async function logTrainingCloud({ empId, scenarioId, scenarioLabel, outcome='completed', score='', durationSec='' }){
    try{
      const headers = { 'Content-Type': 'application/json', 'x-write-token': WRITE_TOKEN };
      const resp = await fetch('/api/logs-write', {
        method: 'POST', headers,
        body: JSON.stringify({ emp_id: empId, scenario_id: scenarioId, scenario_label: scenarioLabel, outcome, score, duration_sec: durationSec })
      });
      if(!resp.ok){
        const t = await resp.text().catch(()=> '');
        console.warn('cloud log failed', resp.status, t);
        return false;
      }
      return true;
    }catch(e){ console.error('cloud log error', e); return false; }
  }

  // ===== wire controls after DOM ready =====
  document.addEventListener('DOMContentLoaded', ()=>{
    try{
      initEmployeeGate();

      const sel = $('scenarioSelect');
      const desc= $('desc');
      const startBtn = $('startBtn');
      const nextBtn  = $('nextBtn');
      const finishBtn= $('finishBtn');
      const statusEl = $('status');

      if(!sel||!startBtn||!nextBtn||!finishBtn){ showErr('One or more required buttons/selector are missing.'); return; }

      $('reloadScenarios')?.addEventListener('click', loadScenarios);

      sel.onchange = (e)=>{
        const id = e.target.value;
        current = scenarios.find(s=>s.id===id) || null;
        setText(desc, current ? (current.desc||'') : 'Select a scenario to begin.');
        stepIndex = 0; renderSteps();
        startBtn.disabled = !current; nextBtn.disabled = true; finishBtn.disabled = true; setText(statusEl,'Idle');
      };

      startBtn.onclick = ()=>{
        if(!current){ setText(statusEl,'Select a scenario first'); return; }
        startTs = Date.now(); stepIndex = 0; renderSteps();
        nextBtn.disabled = false; finishBtn.disabled = false; setText(statusEl,'In progress…');
      };

      nextBtn.onclick = ()=>{
        if(!current) return;
        const total=(current.steps||[]).length;
        if(total===0) return;
        stepIndex = Math.min(stepIndex+1, total-1); renderSteps();
      };

      finishBtn.onclick = async ()=>{
        if(!current) return;
        const duration = Math.round((Date.now()-startTs)/1000) || '';
        const ok = await logTrainingCloud({
          empId: getEmployeeId(),
          scenarioId: current.id || '',
          scenarioLabel: current.label || '',
          outcome: 'completed',
          score: '',
          durationSec: duration
        });
        setText(statusEl, ok ? 'Logged to cloud ✓' : 'Completed (cloud log failed)');
        nextBtn.disabled = true; finishBtn.disabled = true;
      };

      // kick off
      loadScenarios().catch(e=>showErr('Unexpected load error', e));
      renderSteps();
    }catch(e){
      showErr('Fatal script error: '+ (e?.message||e), e);
    }
  });
})();
</script>
</body>
</html>
