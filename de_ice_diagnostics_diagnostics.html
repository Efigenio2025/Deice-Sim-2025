<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>De‚ÄëIce ‚Äî Diagnostics</title>
  <style>
    :root{--bg:#0b0c10;--card:#101218;--ink:#eaeaea;--muted:#96a3bf;--line:#1e2230;--accent:#1f6feb;--ok:#2ea043;--err:#e5534b}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:980px;margin:0 auto;padding:24px}
    h1{margin:0 0 12px;font-size:1.35rem}
    .note{color:var(--muted)}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;margin-top:14px}
    .row{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 12px;border:1px dashed #2b3147;border-radius:10px}
    .grid{display:grid;gap:10px}
    .ok{color:#b9ffd0}
    .err{color:#ffb9b4}
    .btn{display:inline-flex;align-items:center;gap:8px;text-decoration:none;background:var(--accent);color:#fff;padding:10px 12px;border-radius:10px;font-weight:800}
    code{background:#0f1220;border:1px solid #2b3147;border-radius:6px;padding:1px 6px}
    pre{white-space:pre-wrap;background:#0f1220;border:1px solid #2b3147;border-radius:10px;padding:10px;color:#d6e3ff}
    .small{font-size:.92rem}
    .links{display:flex;gap:8px;flex-wrap:wrap}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>De‚ÄëIce ‚Äî Diagnostics</h1>
    <div class="note">Run these checks on the deployed site. Use this page to troubleshoot mic/TTS/JSON issues without exposing details on training or admin screens.</div>

    <div class="card">
      <div class="links">
        <a class="btn" href="index.html">üè† Welcome</a>
        <a class="btn" href="train.html">‚ñ∂ Training</a>
        <a class="btn" href="admin.html">‚öô Admin</a>
      </div>
    </div>

    <section class="card">
      <strong>Environment</strong>
      <div class="grid" id="envGrid"></div>
    </section>

    <section class="card">
      <strong>Static file checks</strong>
      <div class="grid">
        <div class="row"><span>/phrases.json</span><span id="cP" class="note">checking‚Ä¶</span></div>
        <div class="row"><span>/scenarios.json</span><span id="cS" class="note">checking‚Ä¶</span></div>
        <div class="row"><span>/settings.json</span><span id="cT" class="note">optional</span></div>
      </div>
    </section>

    <section class="card">
      <strong>Speech capabilities</strong>
      <div class="grid">
        <div class="row"><span>SpeechRecognition (mic ‚Üí text)</span><span id="cSR" class="note">checking‚Ä¶</span></div>
        <div class="row"><span>SpeechSynthesis (text ‚Üí voice)</span><span id="cSS" class="note">checking‚Ä¶</span></div>
        <div class="row"><span>Voices available</span><span id="cVoices" class="note">checking‚Ä¶</span></div>
        <div class="row"><span>PWA/Standalone mode (iOS blocks SR)</span><span id="cPWA" class="note">checking‚Ä¶</span></div>
        <div class="row"><span>HTTPS (required on iOS for mic)</span><span id="cHTTPS" class="note">checking‚Ä¶</span></div>
      </div>
    </section>

    <section class="card">
      <strong>settings.json applied</strong>
      <div class="grid">
        <div class="row"><span>passThreshold</span><span id="sTh" class="note">‚Äî</span></div>
        <div class="row"><span>ttsVoiceName</span><span id="sVN" class="note">‚Äî</span></div>
        <div class="row"><span>ttsRate</span><span id="sTR" class="note">‚Äî</span></div>
        <div class="row"><span>scenarioAutoTTS</span><span id="sAT" class="note">‚Äî</span></div>
        <div class="row"><span>autoStartMic</span><span id="sAM" class="note">‚Äî</span></div>
      </div>
    </section>

    <section class="card">
      <strong>Console & errors</strong>
      <div class="note small">Anything the page detects will be mirrored here.</div>
      <pre id="log"></pre>
    </section>
  </div>

  <script>
    const logEl = document.getElementById('log');
    function log(msg){ logEl.textContent += msg + '\n'; }
    window.addEventListener('error', e => log('Runtime error: '+(e.message||'unknown')));

    function mark(el, ok, text){ el.textContent = text || (ok ? 'OK' : 'Fail'); el.className = ok ? 'ok' : 'err'; }

    async function probe(path, el){
      try{ const res = await fetch(path, {cache:'no-store'}); mark(el, res.ok, res.ok ? 'OK' : 'HTTP '+res.status); }
      catch(e){ mark(el, false, 'unreachable'); log('Fetch '+path+' ‚Üí '+(e.message||e)); }
    }

    // Environment block
    function envRow(label, value, ok=true){
      const wrap = document.createElement('div');
      wrap.className = 'row';
      const l = document.createElement('span'); l.textContent = label;
      const r = document.createElement('span'); r.textContent = value; r.className = ok ? 'ok' : 'err';
      wrap.appendChild(l); wrap.appendChild(r);
      return wrap;
    }

    async function loadSettings(){
      try {
        const res = await fetch('settings.json', {cache:'no-store'});
        if(!res.ok) { mark(document.getElementById('cT'), false, 'not found (optional)'); return null; }
        const cfg = await res.json();
        mark(document.getElementById('cT'), true, 'OK');
        document.getElementById('sTh').textContent = cfg.passThreshold ?? '‚Äî';
        document.getElementById('sVN').textContent = cfg.ttsVoiceName ?? '‚Äî';
        document.getElementById('sTR').textContent = cfg.ttsRate ?? '‚Äî';
        document.getElementById('sAT').textContent = cfg.scenarioAutoTTS ?? '‚Äî';
        document.getElementById('sAM').textContent = cfg.autoStartMic ?? '‚Äî';
        return cfg;
      } catch(e){ log('settings.json load error: '+(e.message||e)); return null; }
    }

    window.addEventListener('DOMContentLoaded', async () => {
      // Environment
      const env = document.getElementById('envGrid');
      env.appendChild(envRow('User agent', navigator.userAgent));
      env.appendChild(envRow('Platform', navigator.platform || 'n/a'));
      const isStandalone = window.matchMedia('(display-mode: standalone)').matches || (window.navigator.standalone===true);
      env.appendChild(envRow('Standalone/PWA', String(isStandalone), !isStandalone));
      const isHTTPS = location.protocol === 'https:' || location.hostname === 'localhost';
      env.appendChild(envRow('HTTPS/localhost', String(isHTTPS), isHTTPS));

      // Static files
      await probe('phrases.json', document.getElementById('cP'));
      await probe('scenarios.json', document.getElementById('cS'));
      await loadSettings();

      // Speech
      const hasSR = !!(window.SpeechRecognition || window.webkitSpeechRecognition);
      mark(document.getElementById('cSR'), hasSR, hasSR ? 'available' : 'unavailable');
      const hasSS = 'speechSynthesis' in window;
      mark(document.getElementById('cSS'), hasSS, hasSS ? 'available' : 'unavailable');

      if(hasSS){
        // voices may arrive async
        function reportVoices(){
          const list = speechSynthesis.getVoices();
          const count = list ? list.length : 0;
          mark(document.getElementById('cVoices'), count>0, count>0 ? count+' voice(s)' : 'none');
          if(count>0){ log('Voices: '+ list.map(v=>v.name+' ('+v.lang+')').join(', ')); }
        }
        reportVoices();
        speechSynthesis.onvoiceschanged = reportVoices;
      } else {
        mark(document.getElementById('cVoices'), false, 'n/a');
      }

      // PWA & HTTPS badges
      mark(document.getElementById('cPWA'), !isStandalone, isStandalone ? 'standalone (iOS may block mic)' : 'browser mode');
      mark(document.getElementById('cHTTPS'), isHTTPS, isHTTPS ? 'OK' : 'not secure');
    });
  </script>
</body>
</html>
