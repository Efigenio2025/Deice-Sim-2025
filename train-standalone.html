<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>De-Ice Trainer — Standalone</title>
<style>
  :root{--bg:#0b0c10;--card:#101218;--ink:#eaeaea;--muted:#96a3bf;--line:#1e2230;--accent:#1f6feb;--danger:#e5534b;--ok:#19c37d}
  body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:980px;margin:0 auto;padding:16px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .btn{appearance:none;border:0;background:var(--accent);color:#fff;font-weight:800;border-radius:10px;padding:12px 14px;cursor:pointer}
  .ghost{background:#2b3147}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;margin:12px 0}
  .status{color:var(--muted)}
  .live{border:1px solid #223259;border-radius:10px;padding:10px;background:#141822;color:#b7c7ff;min-height:40px}
  .progress{height:12px;background:#1a2136;border:1px solid #223259;border-radius:999px;overflow:hidden}
  .bar{height:100%;width:0;background:linear-gradient(90deg,var(--danger),#f89c2c,#f6e05e,#a4e786,var(--ok));transition:width .25s}
  .tok{display:inline-block;padding:0 4px;border-radius:6px;margin:0 2px 4px 0}
  .ok{background:#12291c;border:1px solid #1f5d38}
  .miss{background:#2a1616;border:1px solid #8a2c2c;text-decoration:underline}
  .extra{background:#1a1d2a;border:1px solid #2f375c;opacity:.9}
  .hidden{display:none!important}
</style>
</head>
<body>
<div class="wrap">
  <div class="row" style="justify-content:space-between">
    <a href="index.html" class="btn ghost">← Home</a>
    <div class="row"><span class="status" id="envBadge">iOS check…</span></div>
  </div>

  <div class="row">
    <button class="btn" onclick="window.__start && window.__start()">Start Simulator</button>
    <button class="btn ghost" onclick="window.__pause && window.__pause()">Pause</button>
  </div>

  <div class="card">
    <h2>Trainer</h2>
    <div class="row">
      <label style="flex:1 1 260px">Select scenario
        <select id="scenarioSelect"></select>
      </label>
    </div>
    <div id="desc" class="status" style="margin-top:6px">Select a scenario to begin.</div>
  </div>

  <div class="card" aria-live="polite">
    <div class="row" style="justify-content:space-between">
      <strong>Live Input</strong>
      <span id="status" class="status">Idle</span>
    </div>
    <div id="live" class="live">(waiting…)</div>
  </div>

  <div id="stepCard" class="card hidden">
    <h2>Step</h2>
    <div id="stepBox" class="status">—</div>
    <div class="row" style="gap:12px;align-items:center;margin-top:8px">
      <div class="status">Score: <strong id="scorePct">0%</strong></div>
      <div class="progress" style="width:300px"><div id="scoreBar" class="bar"></div></div>
    </div>
  </div>

  <div class="card">
    <h2>Transcript</h2>
    <div class="status">Expected</div>
    <div id="expLine"></div>
    <div class="status" style="margin-top:8px">You said</div>
    <div id="heardLine"></div>
    <div id="wordStats" class="status" style="margin-top:6px"></div>
  </div>
</div>

<audio id="captainAudio" preload="metadata" playsinline muted></audio>
  
<script>
/* ===== Inline scenarios (fallback) ===== */
const INLINE_SCENARIOS = [
  {
    "id": "scn1",
    "label": "Full Body Type I Only",
    "desc": "Scenario 1: Full body Type I deicing only with enriched conversational flow",
    "steps": [
      {"prompt":"hail","role":"Captain","text":"Iceman, this is N443DF, do you copy?","audio":"scn1_captain_hail.mp3"},
      {"prompt":"ack_hail","role":"Iceman","text":"N443DF, this is Iceman, go ahead."},
      {"prompt":"init","role":"Captain","text":"Iceman, N443DF, looks like we’ll need a full body Type I deicing today.","audio":"scn1_captain_init.mp3"},
      {"prompt":"prep","role":"Iceman","text":"Copy that N443DF, you are requesting full body Type I. Please prepare the aircraft for deicing."},
      {"prompt":"ready","role":"Captain","text":"Iceman, aircraft N443DF ready for deicing. We are configured for Type I. Engines are running, APU is off.","audio":"scn1_captain_ready.mp3"},
      {"prompt":"start","role":"Iceman","text":"Aircraft N443DF, copy that engines running and APU off, full body Type I requested. Starting Type I application now."},
      {"prompt":"update","role":"Iceman","text":"Aircraft N443DF, do you copy?"},
      {"prompt":"ack_update","role":"Captain","text":"Go ahead, Iceman, for aircraft N443DF.","audio":"scn1_captain_ack_update.mp3"},
      {"prompt":"post","role":"Iceman","text":"Yes, N443DF, deicing complete. Post-deicing check complete, deicing personnel and equipment are safely away."},
      {"prompt":"final","role":"Captain","text":"Iceman, aircraft N443DF copies. Thank you for your help and stay warm out there!","audio":"scn1_captain_final.mp3"}
    ]
  }
];

/* ===== Core helpers (unchanged) ===== */
const $ = id => document.getElementById(id);
const setText = (el,t)=>{ if(el) el.textContent=t; };
const norm = s => String(s||'').toLowerCase().replace(/[^a-z0-9\s]/g,' ').replace(/\s+/g,' ').trim();
const NATO = {A:'Alpha',B:'Bravo',C:'Charlie',D:'Delta',E:'Echo',F:'Foxtrot',G:'Golf',H:'Hotel',I:'India',J:'Juliet',K:'Kilo',L:'Lima',M:'Mike',N:'November',O:'Oscar',P:'Papa',Q:'Quebec',R:'Romeo',S:'Sierra',T:'Tango',U:'Uniform',V:'Victor',W:'Whiskey',X:'X-ray',Y:'Yankee',Z:'Zulu','0':'Zero','1':'One','2':'Two','3':'Three','4':'Four','5':'Five','6':'Six','7':'Seven','8':'Eight','9':'Nine'};
const toNatoTail = t => t.toUpperCase().split('').map(ch=>NATO[ch]||ch).join(' ');
function prepareScenario(scn){
  (scn.steps||[]).forEach(st=>{
    const base=String(st.text||'');
    st._displayLine = base;
    st._expectedForGrade = (st.role==='Iceman') ? base.replace(/\bN[0-9A-Z]{3,}\b/gi, m=>toNatoTail(m)) : base;
  });
}
function wordScore(expected, said){
  const e = new Set(norm(expected).split(' ').filter(Boolean));
  const s = new Set(norm(said).split(' ').filter(Boolean));
  if(!e.size) return 0; let hit=0; e.forEach(w=>{ if(s.has(w)) hit++; }); return Math.round((hit/e.size)*100);
}
function setScorePct(p){ const x=Math.max(0,Math.min(100, p|0)); setText($('scorePct'), x+'%'); $('scoreBar').style.width=x+'%'; }
const tokenize = s => norm(s).split(' ').filter(Boolean);
function diffWords(exp, heard){
  const E=tokenize(exp), H=tokenize(heard); const setE=new Set(E), setH=new Set(H);
  const expToks = E.map(w=>({w, cls:setH.has(w)?'ok':'miss'}));
  const extras  = H.filter(w=>!setE.has(w)).map(w=>({w,cls:'extra'}));
  return {expToks, extras, expCount:E.length, hitCount:E.filter(w=>setH.has(w)).length};
}
function renderToks(el, toks){ if(!el) return; el.innerHTML = toks.map(t=>`<span class="tok ${t.cls}">${t.w}</span>`).join(' '); }

/* ===== State ===== */
let SCENARIOS = [];   // will be filled by loadScenarios()
let current = null, stepIndex=-1, running=false, paused=false, recActive=null;
let stepScores=[];

/* ===== iOS / Audio unlock (unchanged) ===== */
async function unlockAudio(){
  try{ const Ctx=window.AudioContext||window.webkitAudioContext; if(Ctx){ const ctx=new Ctx(); await ctx.resume(); const o=ctx.createOscillator(), g=ctx.createGain(); g.gain.value=0; o.connect(g).connect(ctx.destination); o.start(); o.stop(ctx.currentTime+0.01);} }catch{}
  try{ const a=$('captainAudio'); a.muted=true; await a.play().catch(()=>{}); a.pause(); a.currentTime=0; }catch{}
}

/* ===== Captain audio (unchanged) ===== */
function playCaptainAudio(src){
  const a=$('captainAudio'); if(!a || !src) return Promise.resolve();
  const candidates=[`/audio/${src}`, `/${src}`];
  return new Promise(resolve=>{
    let settled=false; const clean=()=>{ a.onended=a.onerror=a.oncanplay=a.onloadedmetadata=null; };
    const tryUrl=(i)=>{
      if(i>=candidates.length){ if(!settled){ settled=true; resolve(); } return; }
      clean(); try{ a.pause(); a.currentTime=0; }catch{}; a.src=candidates[i];
      a.oncanplay=()=>{ a.muted=false; a.onended=()=>{ clean(); if(!settled){ settled=true; resolve(); } }; a.play().catch(()=>{ if(!settled){ settled=true; resolve(); } }); setText($('status'),'Playing Captain…'); };
      a.onerror=()=>tryUrl(i+1);
    }; tryUrl(0);
  });
}

/* ===== Mic listen (unchanged from last patch) ===== */
function throttle(fn, ms){ let t=0; return (...a)=>{ const n=Date.now(); if(n-t>=ms){ t=n; fn(...a);} }; }
async function listenStep({minMs=1500, maxMs=6000, silenceMs=1200}={}){
  return new Promise(resolve=>{
    const R=window.SpeechRecognition||window.webkitSpeechRecognition;
    if(!R){ resolve({final:'',interim:'',ended:'nosr'}); return; }
    let finalText='', interimText=''; let started=Date.now(), lastAct=started, stopped=false;
    const live = throttle(t=> $('live').textContent = t || '(listening…)', 60);
    const shouldStop=()=>{ const now=Date.now(), elapsed=now-started, idle=now-lastAct; if(elapsed<minMs) return false; if(idle>=silenceMs) return true; if(elapsed>=maxMs) return true; return false; };
    const rec=new R(); rec.lang='en-US'; rec.continuous=false; rec.interimResults=true; rec.maxAlternatives=1;
    rec.onstart=()=>{ lastAct=Date.now(); setText($('status'),'Listening…'); };
    rec.onsoundstart=()=>{ lastAct=Date.now(); };
    rec.onspeechstart=()=>{ lastAct=Date.now(); };
    rec.onresult=(ev)=>{ let interim=''; for(let i=ev.resultIndex;i<ev.results.length;i++){ const tr=ev.results[i][0]?.transcript||''; if(tr) lastAct=Date.now(); if(ev.results[i].isFinal){ finalText += (finalText?' ':'')+tr; } else { interim += (interim?' ':'')+tr; } } interimText=interim; const combined=(finalText?(finalText+' '):'')+interimText; $('heardLine').textContent=combined.trim(); live(interimText||combined); };
    rec.onerror=()=>{ if(shouldStop()) end('error'); else restart(); };
    rec.onend=()=>{ if(shouldStop()) end('ended'); else restart(); };
    function restart(){ if(stopped) return; setTimeout(()=>{ try{ rec.start(); }catch{ if(shouldStop()) end('start-failed'); } }, 140); }
    function end(reason){ if(stopped) return; stopped=true; try{ rec.abort(); }catch{}; resolve({final:finalText.trim(),interim:interimText.trim(),ended:reason}); }
    try{ rec.start(); recActive=rec; }catch(e){ resolve({final:'',interim:'',ended:'start-failed'}); }
  });
}

/* ===== Render & run (unchanged) ===== */
function renderActive(){
  const card=$('stepCard'), box=$('stepBox');
  if(!current || stepIndex<0 || stepIndex>=current.steps.length){ card.classList.add('hidden'); setText(box,'—'); return; }
  card.classList.remove('hidden');
  const st=current.steps[stepIndex]; box.innerHTML = `<div style="padding:8px;border:1px solid #1f6feb;border-radius:10px;background:#0f1424">
    <div style="display:flex;justify-content:space-between"><strong>Step ${stepIndex+1} • ${st.role}</strong><span class="status">${st.prompt||''}</span></div>
    <div style="margin-top:6px">${(st._displayLine||st.text||'').replace(/</g,'&lt;')}</div></div>`;
  const tokens = tokenize(st._displayLine||st.text||'').map(w=>({w,cls:'ok'}));
  renderToks($('expLine'), tokens); $('heardLine').innerHTML=''; setText($('wordStats'),'');
}
function setScore(p){ p=Math.max(0,Math.min(100,p|0)); setText($('scorePct'), p+'%'); $('scoreBar').style.width=p+'%'; }
async function run(){
  running=true; paused=false; setScore(0); setText($('status'),'Running…'); $('live').textContent='(waiting…)';
  const steps=current.steps||[]; let scores=[];
  for(let i=0;i<steps.length;i++){
    if(!running||paused) break;
    stepIndex=i; renderActive();
    const st=steps[i];
    if(st.role==='Captain'){ await playCaptainAudio(st.audio||''); await new Promise(r=>setTimeout(r,900)); }
    else{
      const {final,interim}=await listenStep(); const heard=(final||interim||'').trim();
      const expectedGrade=st._expectedForGrade || st.text || ''; const expectedDisplay=st._displayLine || st.text || '';
      const {expToks, extras, expCount, hitCount}=diffWords(expectedDisplay, heard);
      const score=wordScore(expectedGrade, heard); scores.push(score);
      renderToks($('expLine'), expToks); renderToks($('heardLine'), extras.length?extras:[{w:heard||'—',cls:heard?'ok':'miss'}]);
      setText($('wordStats'), `${hitCount}/${expCount} expected words matched • Step score ${score}%`);
      setScore(Math.round(scores.reduce((a,b)=>a+b,0)/scores.length)); setText($('status'), heard?`Heard: "${heard}"`:'No speech detected.'); $('live').textContent=heard||'(listening done)';
    }
  }
  running=false; setText($('status'),'Complete');
}

/* ===== Load scenarios: try /scenarios.json, else use inline ===== */
async function loadScenariosWithFallback(){
  let scenarios = [];
  try{
    const r = await fetch('/scenarios.json?v='+Date.now(), {cache:'no-store'});
    if (r.ok) {
      const data = await r.json();
      if (Array.isArray(data) && data.length) {
        scenarios = data;
        console.log('Loaded scenarios.json:', data.length);
      } else {
        console.warn('scenarios.json present but empty/invalid, using inline fallback.');
      }
    } else {
      console.warn('scenarios.json HTTP', r.status, '- using inline fallback.');
    }
  } catch (e) {
    console.warn('scenarios.json fetch error, using inline fallback:', e);
  }
  if (!scenarios.length) scenarios = INLINE_SCENARIOS.slice();
  scenarios.forEach(prepareScenario);
  return scenarios;
}

/* ===== Boot ===== */
(async function init(){
  // Env badge
  const standalone = window.matchMedia('(display-mode: standalone)').matches || (window.navigator.standalone===true);
  const https = location.protocol==='https:' || location.hostname==='localhost';
  const hasSR = !!(window.SpeechRecognition||window.webkitSpeechRecognition);
  setText($('envBadge'), `SR:${hasSR?'yes':'no'} • HTTPS:${https?'yes':'no'} • PWA:${standalone?'yes':'no'}`);

  // Load scenarios (fetch or fallback)
  SCENARIOS = await loadScenariosWithFallback();
  const sel=$('scenarioSelect');
  if (SCENARIOS.length === 0) {
    sel.innerHTML = '<option value="">(no scenarios found)</option>';
    setText($('desc'), 'No scenarios found. Check scenarios.json or the inline fallback.');
  } else {
    sel.innerHTML = SCENARIOS.map(s=>`<option value="${s.id}">${s.label||s.id}</option>`).join('');
    sel.onchange = e => { const id=e.target.value; current=SCENARIOS.find(s=>s.id===id)||null; setText($('desc'), current?(current.desc||''):'Select a scenario to begin.'); stepIndex=-1; renderActive(); };
    sel.value = SCENARIOS[0].id; sel.dispatchEvent(new Event('change'));
  }

  // Start/Pause handlers
  window.__start = async ()=>{ await unlockAudio(); if(!current){ setText($('status'),'Select a scenario first.'); return; } run().catch(()=>{}); };
  window.__pause = ()=>{ running=false; paused=true; try{ recActive&&recActive.abort&&recActive.abort(); }catch{}; setText($('status'),'Paused'); };
})();
</script>
