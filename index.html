<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>De-Ice Verbiage Trainer v1</title>
  <style>
    :root { --bg:#0b0c10; --card:#101218; --muted:#a3a3a3; --ok:#2ea043; --warn:#e5534b; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:#eaeaea;font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial}
    .wrap{max-width:880px;margin:0 auto;padding:24px}
    .card{background:var(--card);border:1px solid #1e2230;border-radius:16px;padding:18px 18px}
    h1{font-size:1.4rem;margin:0 0 12px}
    h2{font-size:1.05rem;margin:16px 0 8px}
    label{display:block;font-weight:600;margin:12px 0 6px}
    select, input[type="text"], textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #2b3147;background:#0f1220;color:#eee}
    .row{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:760px){.row{grid-template-columns:1fr 1fr}}
    .target{padding:12px;border-radius:10px;background:#0c0f1d;border:1px dashed #2b3147;color:#cfe1ff}
    .controls{display:flex;align-items:center;gap:12px;margin-top:8px}
    button{appearance:none;border:0;background:#1f6feb;color:#fff;padding:12px 16px;border-radius:12px;font-weight:700;cursor:pointer}
    button[disabled]{opacity:.5;cursor:not-allowed}
    .ghost{background:#2b3147}
    .status{font-size:.95rem;color:var(--muted)}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;font-weight:700;font-size:.9rem}
    .pass{background:color-mix(in oklab, var(--ok) 25%, #000 75%);color:#d9ffe2;border:1px solid color-mix(in oklab, var(--ok), #000 70%)}
    .fail{background:color-mix(in oklab, var(--warn) 25%, #000 75%);color:#ffe2e0;border:1px solid color-mix(in oklab, var(--warn), #000 70%)}
    .meter{height:10px;background:#131831;border-radius:999px;overflow:hidden;border:1px solid #2b3147}
    .meter>span{display:block;height:100%;background:linear-gradient(90deg,#1f6feb,#2ea043);width:0}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}
    details{margin-top:8px}
    .note{color:var(--muted);font-size:.95rem}
    footer{margin-top:18px;color:#95a0b6;font-size:.85rem}
  /* App-style shell */
    .topbar{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,#0e1324,#0b0c10);border-bottom:1px solid #1e2230;height:56px;display:flex;align-items:center;gap:12px;padding:0 16px}
    .topbar .title{font-weight:800;letter-spacing:.2px}
    .badge{font-size:.72rem;background:#16213a;border:1px solid #223259;border-radius:999px;padding:2px 8px;color:#b7c7ff}
    .bnav{position:fixed;left:0;right:0;bottom:0;z-index:10;background:linear-gradient(180deg,#101218,#0b0c10);border-top:1px solid #1e2230;height:62px;display:grid;grid-template-columns:repeat(3,1fr)}
    .bbtn{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;color:var(--muted);font-size:.8rem;text-decoration:none}
    .bbtn[aria-current="page"]{color:#d9e6ff}
    .infoBox{margin-top:12px;padding:10px;border-radius:8px;background:#0f1220;border:1px solid #2b3147;color:#cfe1ff;font-size:.9rem}
  </style>
</head>
<body>
  <header class="topbar">
      <div class="title">De-Ice Trainer</div>
      <span class="badge">v1</span>
    </header>
    <div class="wrap" style="padding-top:72px;padding-bottom:74px">
    <div class="card">
      <h1>De-Ice Verbiage Trainer v1</h1>
      <div id="iosWarn" class="note" style="display:none;border:1px solid #3a3f55;padding:8px 10px;border-radius:8px;margin:8px 0">
        iOS Safari: use an HTTPS link, open in Safari (not ‚ÄúAdd to Home Screen‚Äù), and allow microphone in Settings ‚ñ∏ Safari ‚ñ∏ Microphone.
      </div>
      <p class="note">Speak the selected phrase. The app will listen, transcribe, and score your attempt locally in your browser.</p>

      <label for="phrase">Target phrase</label>
      <select id="phrase"></select>
      <div id="target" class="target mono"></div>
      <div id="fluidInfo" class="infoBox" style="display:none"></div>

      <div class="controls">
        <button id="micBtn">üé§ Start speaking</button>
        <button id="stopBtn" class="ghost" disabled>‚ñ† Stop</button>
        <span id="status" class="status">Idle</span>
      </div>

      <div class="row" style="margin-top:14px">
        <div>
          <h2>Your speech (transcript)</h2>
          <div id="you" class="target mono" style="min-height:64px"></div>
        </div>
        <div>
          <h2>Score</h2>
          <div class="meter" aria-label="match %"><span id="bar"></span></div>
          <div style="display:flex;align-items:center;gap:8px;margin-top:10px">
            <div id="scorePill" class="pill fail">0%</div>
            <div id="verdict" class="status">Needs correction</div>
          </div>
          <details>
            <summary>Settings</summary>
            <label for="th">Pass threshold: <span id="thLabel">90%</span></label>
            <input id="th" type="range" min="50" max="98" value="90" />
            <p class="note">Tip: In the phrases below, numbers are written as words (e.g., ‚ÄúType one‚Äù, ‚ÄúType four‚Äù) to improve speech-to-text matching.</p>
          </details>
        </div>
      </div>

      <details>
        <summary>Can‚Äôt use the mic? Type instead</summary>
        <label for="typed">Type what you would say</label>
        <textarea id="typed" rows="3" placeholder="Type here‚Ä¶"></textarea>
        <div class="controls"><button id="checkBtn">Check typed text</button></div>
      </details>

      <footer>
        <strong>Note:</strong> Phrases are placeholders for training only. Confirm exact airline/OAA/EGOM verbiage before production use.
      </footer>
    </div>
  </div>

  <script>
    // --- Configuration (hard-coded for v1) ---
    let PHRASES = []; // loaded from phrases.json

    const els = {
      phrase: document.getElementById('phrase'),
      target: document.getElementById('target'),
      fluidInfo: document.getElementById('fluidInfo'),
      micBtn: document.getElementById('micBtn'),
      stopBtn: document.getElementById('stopBtn'),
      status: document.getElementById('status'),
      you: document.getElementById('you'),
      bar: document.getElementById('bar'),
      pill: document.getElementById('scorePill'),
      verdict: document.getElementById('verdict'),
      th: document.getElementById('th'),
      thLabel: document.getElementById('thLabel'),
      typed: document.getElementById('typed'),
      checkBtn: document.getElementById('checkBtn'),
    };

    function populateDropdown(){
    els.phrase.innerHTML = '';
    PHRASES.forEach(p => {
      const opt = document.createElement('option');
      opt.value = p.id; opt.textContent = p.label; els.phrase.appendChild(opt);
    });
  }

  async function loadPhrases(){
    els.status.textContent = 'Loading phrases‚Ä¶';
    setMicEnabled(false);
    try{
      const res = await fetch('phrases.json', { cache:'no-store' });
      if(!res.ok) throw new Error('HTTP ' + res.status);
      const data = await res.json();
      if(!Array.isArray(data) || data.length===0) throw new Error('Empty or invalid phrases');
      PHRASES = data;
      populateDropdown();
      setTargetText();
      els.status.textContent = 'Idle';
      setMicEnabled(true);
    }catch(err){
      els.status.textContent = 'Load error: ' + err.message;
    }
  }

  els.phrase.addEventListener('change', setTargetText);
  loadPhrases();

    // Helpers
    const normalize = s => s.toLowerCase().replace(/[^\w\s]/g,' ').replace(/\s+/g,' ').trim();

    function levenshteinWords(a, b){
      const A = normalize(a).split(' ').filter(Boolean);
      const B = normalize(b).split(' ').filter(Boolean);
      const m = A.length, n = B.length;
      const dp = Array.from({length:m+1},()=>Array(n+1).fill(0));
      for(let i=0;i<=m;i++) dp[i][0]=i;
      for(let j=0;j<=n;j++) dp[0][j]=j;
      for(let i=1;i<=m;i++){
        for(let j=1;j<=n;j++){
          const cost = (A[i-1]===B[j-1])?0:1;
          dp[i][j] = Math.min(
            dp[i-1][j] + 1,      // deletion
            dp[i][j-1] + 1,      // insertion
            dp[i-1][j-1] + cost  // substitution
          );
        }
      }
      const dist = dp[m][n];
      const maxLen = Math.max(m, n) || 1;
      const score = Math.max(0, 1 - dist/maxLen);
      return { score, dist, wordsA:m, wordsB:n };
    }

    function updateScore(transcript){
      const target = getTarget();
      const { score } = levenshteinWords(transcript, target);
      const pct = Math.round(score*100);
      const pass = pct >= Number(els.th.value);
      els.bar.style.width = pct + '%';
      els.pill.textContent = pct + '%';
      els.pill.className = 'pill ' + (pass ? 'pass':'fail');
      els.verdict.textContent = pass ? 'Match' : 'Needs correction';
    }

    // Threshold UI
    function syncThreshold(){ els.thLabel.textContent = els.th.value + '%'; }
    els.th.addEventListener('input', syncThreshold); syncThreshold();

    // Manual typing fallback
    els.checkBtn.addEventListener('click', () => {
      const t = els.typed.value || '';
      els.you.textContent = t;
      updateScore(t);
    });

    // Speech recognition
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition || null;
    let recognition = null;
    // Detect PWA/standalone where iOS may block Web Speech API
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches || (window.navigator.standalone === true);

    function setMicEnabled(on){
      els.micBtn.disabled = !on; els.stopBtn.disabled = on; // flip
    }

    if (SR && isStandalone) {
      // iOS Safari in standalone/PWA often blocks recognition
      document.getElementById('iosWarn').style.display = '';
      els.status.textContent = 'Open this link in Safari (not installed to Home Screen) to use the mic.';
      setMicEnabled(false);
    } else if (!SR){
      els.status.innerHTML = 'Speech recognition not supported in this browser. Try iOS Safari 14.5+ over HTTPS or Chrome desktop.';
      setMicEnabled(false);
    } else {
      recognition = new SR();
      recognition.lang = 'en-US';
      recognition.interimResults = true;
      recognition.continuous = false; // single phrase per press (more reliable on iOS)
      recognition.maxAlternatives = 1;

      recognition.onstart = () => { els.status.textContent = 'Listening‚Ä¶'; setMicEnabled(false); };
      recognition.onerror = (e) => {
        const err = e.error || 'unknown';
        els.status.textContent = 'Error: ' + err;
        if (err === 'not-allowed' || err === 'service-not-allowed') {
          const warn = document.getElementById('iosWarn'); if (warn) warn.style.display = '';
        }
        setMicEnabled(true);
      };
      recognition.onend = () => { els.status.textContent = 'Idle'; setMicEnabled(true); };

      recognition.onresult = (event) => {
        let finalTranscript = '';
