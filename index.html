<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>De-Ice Verbiage Trainer v1</title>
  <style>
    :root { --bg:#0b0c10; --card:#101218; --muted:#a3a3a3; --ok:#2ea043; --warn:#e5534b; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:#eaeaea;font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial}
    .wrap{max-width:880px;margin:0 auto;padding:24px}
    .card{background:var(--card);border:1px solid #1e2230;border-radius:16px;padding:18px 18px}
    h1{font-size:1.4rem;margin:0 0 12px}
    h2{font-size:1.05rem;margin:16px 0 8px}
    label{display:block;font-weight:600;margin:12px 0 6px}
    select, input[type="text"], textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #2b3147;background:#0f1220;color:#eee}
    .row{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:760px){.row{grid-template-columns:1fr 1fr}}
    .target{padding:12px;border-radius:10px;background:#0c0f1d;border:1px dashed #2b3147;color:#cfe1ff}
    .controls{display:flex;align-items:center;gap:12px;margin-top:8px}
    button{appearance:none;border:0;background:#1f6feb;color:#fff;padding:12px 16px;border-radius:12px;font-weight:700;cursor:pointer}
    button[disabled]{opacity:.5;cursor:not-allowed}
    .ghost{background:#2b3147}
    .status{font-size:.95rem;color:var(--muted)}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;font-weight:700;font-size:.9rem}
    .pass{background:color-mix(in oklab, var(--ok) 25%, #000 75%);color:#d9ffe2;border:1px solid color-mix(in oklab, var(--ok), #000 70%)}
    .fail{background:color-mix(in oklab, var(--warn) 25%, #000 75%);color:#ffe2e0;border:1px solid color-mix(in oklab, var(--warn), #000 70%)}
    .meter{height:10px;background:#131831;border-radius:999px;overflow:hidden;border:1px solid #2b3147}
    .meter>span{display:block;height:100%;background:linear-gradient(90deg,#1f6feb,#2ea043);width:0}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}
    details{margin-top:8px}
    .note{color:var(--muted);font-size:.95rem}
    footer{margin-top:18px;color:#95a0b6;font-size:.85rem}
    .infoBox{margin-top:12px;padding:10px;border-radius:8px;background:#0f1220;border:1px solid #2b3147;color:#cfe1ff;font-size:.9rem}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>De-Ice Verbiage Trainer v1</h1>
      <div id="iosWarn" class="note" style="display:none;border:1px solid #3a3f55;padding:8px 10px;border-radius:8px;margin:8px 0">
        iOS Safari: use an HTTPS link, open in Safari (not ‚ÄúAdd to Home Screen‚Äù), and allow microphone in Settings ‚ñ∏ Safari ‚ñ∏ Microphone.
      </div>
      <p class="note">Speak the selected phrase. The app will listen, transcribe, and score your attempt locally in your browser.</p>

      <label for="phrase">Target phrase</label>
      <select id="phrase"></select>
      <div id="target" class="target mono"></div>
      <div id="fluidInfo" class="infoBox" style="display:none"></div>
      <div id="alert" class="infoBox" style="display:none;border-color:#5c2b2f;background:#1d0f11;color:#ffd9dd">Could not load <code>phrases.json</code>. Using built‚Äëin defaults. Make sure <code>phrases.json</code> is in the repo root next to <code>index.html</code> and that <code>/phrases.json</code> opens in your browser.</div>

      <div class="controls">
        <button id="micBtn">üé§ Start speaking</button>
        <button id="stopBtn" class="ghost" disabled>‚ñ† Stop</button>
        <span id="status" class="status">Idle</span>
      </div>

      <div class="row" style="margin-top:14px">
        <div>
          <h2>Your speech (transcript)</h2>
          <div id="you" class="target mono" style="min-height:64px"></div>
        </div>
        <div>
          <h2>Score</h2>
          <div class="meter" aria-label="match %"><span id="bar"></span></div>
          <div style="display:flex;align-items:center;gap:8px;margin-top:10px">
            <div id="scorePill" class="pill fail">0%</div>
            <div id="verdict" class="status">Needs correction</div>
          </div>
          <details>
            <summary>Settings</summary>
            <label for="th">Pass threshold: <span id="thLabel">90%</span></label>
            <input id="th" type="range" min="50" max="98" value="90" />
            <p class="note">Tip: Numbers are written as words (e.g., "Type one", "Type four") to improve speech‚Äëto‚Äëtext matching.</p>
          </details>
        </div>
      </div>

      <details>
        <summary>Can‚Äôt use the mic? Type instead</summary>
        <label for="typed">Type what you would say</label>
        <textarea id="typed" rows="3" placeholder="Type here‚Ä¶"></textarea>
        <div class="controls"><button id="checkBtn">Check typed text</button></div>
      </details>

      <details id="debug" class="infoBox" open style="display:none"><summary>Diagnostics</summary><pre id="debugPre" class="mono" style="white-space:pre-wrap"></pre></details>

      <footer>
        <strong>Note:</strong> Phrases are for training only. Confirm exact airline/OAA/EGOM verbiage before production use.
      </footer>
    </div>
  </div>

  <script>
    // Data source: load from phrases.json; fallback to embedded JSON; fallback to minimal list
    let PHRASES = [];

    const els = {
      phrase: document.getElementById('phrase'),
      target: document.getElementById('target'),
      fluidInfo: document.getElementById('fluidInfo'),
      micBtn: document.getElementById('micBtn'),
      stopBtn: document.getElementById('stopBtn'),
      status: document.getElementById('status'),
      you: document.getElementById('you'),
      bar: document.getElementById('bar'),
      pill: document.getElementById('scorePill'),
      verdict: document.getElementById('verdict'),
      th: document.getElementById('th'),
      thLabel: document.getElementById('thLabel'),
      typed: document.getElementById('typed'),
      checkBtn: document.getElementById('checkBtn'),
    };

    function populateDropdown(){
      els.phrase.innerHTML = '';
      PHRASES.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.id; opt.textContent = p.label; els.phrase.appendChild(opt);
      });
    }

    function getTarget(){
      const p = PHRASES.find(x => x.id === els.phrase.value) || PHRASES[0];
      return p.text;
    }

    function setTargetText(){
      const p = PHRASES.find(x => x.id === els.phrase.value) || PHRASES[0];
      els.target.textContent = p.text;
      if (p.fluid) { els.fluidInfo.style.display = 'block'; els.fluidInfo.textContent = p.fluid; }
      else { els.fluidInfo.style.display = 'none'; }
    }

    // Loading logic with diagnostics and embedded fallback
    async function loadPhrases(){
      const debug = (m)=>{ const d=document.getElementById('debug'); const p=document.getElementById('debugPre'); if(d&&p){ d.style.display='block'; p.textContent += (m+'\n'); } };
      els.status.textContent = 'Loading phrases‚Ä¶';
      setMicEnabled(false);
      const tries = ['phrases.json', '/phrases.json'];
      let ok = false; let lastErr = '';
      for(const url of tries){
        try{
          debug('Fetching: '+url);
          const res = await fetch(url, { cache:'no-store' });
          debug('HTTP: '+res.status+' '+res.statusText);
          if(!res.ok) throw new Error('HTTP '+res.status+' '+res.statusText);
          const data = await res.json();
          if(!Array.isArray(data) || data.length===0) throw new Error('Empty or invalid JSON array');
          PHRASES = data; ok = true; debug('Loaded '+data.length+' phrases from '+url); break;
        }catch(err){ lastErr = err.message || String(err); debug('Error: '+lastErr); }
      }
      if(!ok){
        try{
          const raw = document.getElementById('phrasesData').textContent;
          const data = JSON.parse(raw);
          if(Array.isArray(data) && data.length>0){
            PHRASES = data; ok = true; document.getElementById('alert').style.display = 'block';
            debug('Loaded embedded phrases ('+data.length+')');
          }
        }catch(e){ debug('Embedded JSON parse error: '+(e.message||e)); }
      }
      if(!ok){
        PHRASES = [{ id:'pre', label:'Before Deicing/Anti-icing', text:'Captain, please prepare the aircraft for deicing', fluid:'' }];
        document.getElementById('alert').style.display = 'block';
        debug('Using minimal hardcoded fallback');
      }
      populateDropdown();
      setTargetText();
      els.status.textContent = 'Idle';
      setMicEnabled(true);
    }

    // --- Scoring helpers ---
    const normalize = s => s.toLowerCase().replace(/[^\w\s]/g,' ').replace(/\s+/g,' ').trim();
    function levenshteinWords(a, b){
      const A = normalize(a).split(' ').filter(Boolean);
      const B = normalize(b).split(' ').filter(Boolean);
      const m = A.length, n = B.length;
      const dp = Array.from({length:m+1},()=>Array(n+1).fill(0));
      for(let i=0;i<=m;i++) dp[i][0]=i;
      for(let j=0;j<=n;j++) dp[0][j]=j;
      for(let i=1;i<=m;i++){
        for(let j=1;j<=n;j++){
          const cost = (A[i-1]===B[j-1])?0:1;
          dp[i][j] = Math.min(
            dp[i-1][j] + 1,
            dp[i][j-1] + 1,
            dp[i-1][j-1] + cost
          );
        }
      }
      const dist = dp[m][n];
      const maxLen = Math.max(m, n) || 1;
      const score = Math.max(0, 1 - dist/maxLen);
      return { score };
    }

    function updateScore(transcript){
      const target = getTarget();
      const { score } = levenshteinWords(transcript, target);
      const pct = Math.round(score*100);
      const pass = pct >= Number(els.th.value);
      els.bar.style.width = pct + '%';
      els.pill.textContent = pct + '%';
      els.pill.className = 'pill ' + (pass ? 'pass':'fail');
      els.verdict.textContent = pass ? 'Match' : 'Needs correction';
    }

    function syncThreshold(){ els.thLabel.textContent = els.th.value + '%'; }

    // Manual typing fallback
    els.checkBtn?.addEventListener('click', () => {
      const t = els.typed.value || '';
      els.you.textContent = t;
      updateScore(t);
    });

    // Speech recognition
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition || null;
    let recognition = null;
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches || (window.navigator.standalone === true);

    function setMicEnabled(on){ els.micBtn.disabled = !on; els.stopBtn.disabled = on; }

    if (SR && isStandalone) {
      document.getElementById('iosWarn').style.display = '';
      els.status.textContent = 'Open this link in Safari (not installed to Home Screen) to use the mic.';
      setMicEnabled(false);
    } else if (!SR){
      els.status.innerHTML = 'Speech recognition not supported in this browser. Try iOS Safari 14.5+ over HTTPS or Chrome desktop.';
      setMicEnabled(false);
    } else {
      recognition = new SR();
      recognition.lang = 'en-US';
      recognition.interimResults = true;
      recognition.continuous = false;
      recognition.maxAlternatives = 1;

      recognition.onstart = () => { els.status.textContent = 'Listening‚Ä¶'; setMicEnabled(false); };
      recognition.onerror = (e) => {
        const err = e.error || 'unknown';
        els.status.textContent = 'Error: ' + err;
        if (err === 'not-allowed' || err === 'service-not-allowed') {
          const warn = document.getElementById('iosWarn'); if (warn) warn.style.display = '';
        }
        setMicEnabled(true);
      };
      recognition.onend = () => { els.status.textContent = 'Idle'; setMicEnabled(true); };
      recognition.onresult = (event) => {
        let finalTranscript = '';
        for (let i=event.resultIndex; i<event.results.length; i++){
          const res = event.results[i];
          finalTranscript += res[0].transcript;
        }
        finalTranscript = finalTranscript.trim();
        els.you.textContent = finalTranscript;
        if (finalTranscript) updateScore(finalTranscript);
      };

      els.micBtn.addEventListener('click', () => { try{ recognition.start(); }catch(err){} });
      els.stopBtn.addEventListener('click', () => recognition.stop());
    }

    els.phrase.addEventListener('change', setTargetText);
    els.th.addEventListener('input', syncThreshold); syncThreshold();

    // Kick off
    loadPhrases();
  </script>

  <!-- Embedded default phrases (used if phrases.json cannot be fetched) -->
  <script id="phrasesData" type="application/json">[
    {"id":"pre","label":"Before Deicing/Anti-icing","text":"Captain, please prepare the aircraft for deicing","fluid":""},
    {"id":"complete","label":"Deicing complete (Type I)","text":"Deicing complete. Type one fluid applied. Aircraft surfaces are clean.","fluid":"Type I: Heated glycol-based fluid, used primarily for removing frost, ice, or snow. Provides limited anti-icing holdover time."},
    {"id":"anti","label":"Anti-icing applied (Type IV)","text":"Anti icing applied. Type four fluid applied. Aircraft protected.","fluid":"Type IV: Thickened anti-icing fluid applied after Type I. Provides extended holdover protection until takeoff."},
    {"id":"post","label":"Post Deice Only Communication","text":"Captain, registration number, deicing complete. Post deicing check complete, deicing personnel and equipment are safely away","fluid":""},
    {"id":"progress","label":"In progress / hold","text":"Deicing in progress. Please hold position.","fluid":""},
    {"id":"postFull","label":"Post Deicing/Anti-icing Communication (Generic)","text":"Captain, final fluid type applied (Type I or IV), manufacturer and brand name of the fluid. For Type IV specify percentage used: one hundred percent. Local time (HH:MM) when the final anti-icing step began. Post deicing/anti-icing complete, deicing personnel and equipment are safely away.","fluid":""},
    {"id":"postEx1","label":"Post Deicing/Anti-icing Example ‚Äì Deicing Only","text":"Captain, registration number, deicing complete. Post deicing check complete, deicing personnel and equipment are safely away.","fluid":""},
    {"id":"postEx2","label":"Post Deicing/Anti-icing Example ‚Äì Type I/Type IV","text":"Captain, registration number, you have been anti-iced with Type IV, Clariant Safewing MP IV Launch at one hundred percent, starting at 13:48. Post deicing/anti-icing check complete, deicing personnel and equipment are safely away.","fluid":""},
    {"id":"postEx3","label":"Post Deicing/Anti-icing Example ‚Äì Type I/Type I","text":"Captain, registration number, you have been anti-iced with Type I Polar Plus LT, starting at 13:48. Post deicing/anti-icing check complete, deicing personnel and equipment are safely away.","fluid":""},
    {"id":"preTakeoffA","label":"Pre-Takeoff Contamination Check ‚Äì Ready","text":"The Pre-Takeoff Contamination Check has been completed and the aircraft and engines are ready for departure.","fluid":""},
    {"id":"preTakeoffB","label":"Pre-Takeoff Contamination Check ‚Äì Require Deicing","text":"The Pre-Takeoff Contamination Check has been completed and the aircraft and engines require deicing.","fluid":""}
  ]</script>
</body>
</html>
